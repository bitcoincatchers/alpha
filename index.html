<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaBot v2.0 - Professional Trading Signals Dashboard</title>
    <meta name="description" content="Professional trading signals dashboard with real-time ROI tracking">
    <meta name="author" content="Alex - Professional Calisthenics Athlete & Crypto Educator">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Solana Web3.js for blockchain transactions -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        :root {
            --primary-color: #007AFF;
            --primary-hover: #0066cc;
            --bg-dark: #000000;
            --bg-card: #111111;
            --bg-card-hover: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #666666;
            --border-color: #333333;
            --border-hover: #444444;
            --success-color: #00ff88;
            --success-bg: rgba(0, 255, 136, 0.1);
            --success-border: rgba(0, 255, 136, 0.2);
            --danger-color: #ff0066;
            --warning-color: #ffaa00;
            --purple-color: #8b5cf6;
            --green-color: #10b981;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .signal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .signal-card:hover {
            border-color: var(--primary-color);
            background: var(--bg-card-hover);
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.15);
        }
        
        .roi-positive {
            color: var(--success-color);
            background: var(--success-bg);
            border: 1px solid var(--success-border);
        }
        
        .roi-neutral {
            color: var(--text-secondary);
            background: rgba(136, 136, 136, 0.1);
            border: 1px solid rgba(136, 136, 136, 0.2);
        }
        
        .chart-btn {
            background: var(--primary-color);
            color: white;
            transition: all 0.3s ease;
        }
        
        .chart-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* Wallet and Green Button Styles */
        .btn-green {
            background: var(--green-color);
            transition: all 0.3s ease;
        }
        
        .btn-green:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-green:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Wallet info styling */
        #wallet-info {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Enhanced Alert Banner */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #007AFF, #00C7FF);
            color: white;
            padding: 15px 20px;
            transform: translateY(-100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 25px rgba(0, 122, 255, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .alert-banner.show {
            transform: translateY(0);
        }
        
        .alert-banner .pulse-dot {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 1001;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .loading-spinner {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, var(--purple-color), #7c3aed);
            transition: all 0.3s ease;
        }
        
        .btn-purple:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        
        .btn-green {
            background: linear-gradient(135deg, var(--green-color), #059669);
            transition: all 0.3s ease;
        }
        
        .btn-green:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { 
            background: var(--success-color); 
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }
        .status-offline { 
            background: var(--danger-color); 
            box-shadow: 0 0 8px rgba(255, 0, 102, 0.5);
        }
        .status-warning { 
            background: var(--warning-color); 
            box-shadow: 0 0 8px rgba(255, 170, 0, 0.5);
        }
        
        /* Push content when banner is visible */
        body.banner-visible {
            padding-top: 70px;
        }
        
        /* Enhanced form inputs */
        .form-input {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        /* Smooth animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced stats cards */
        .stats-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-card-hover));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--border-hover);
        }

        /* Custom Slider Styles for Sell Percentage */
        .slider-orange {
            background: linear-gradient(to right, #374151 0%, #374151 100%);
            outline: none;
        }
        
        .slider-orange::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f97316, #dc2626);
            border: 2px solid #ffffff;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(249, 115, 22, 0.3);
            transition: all 0.3s ease;
        }
        
        .slider-orange::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(249, 115, 22, 0.4);
        }
        
        .slider-orange::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f97316, #dc2626);
            border: 2px solid #ffffff;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(249, 115, 22, 0.3);
            transition: all 0.3s ease;
        }
        
        .slider-orange::-moz-range-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
        }
        
        .slider-orange::-moz-range-progress {
            background: linear-gradient(to right, #f97316, #dc2626);
            height: 8px;
            border-radius: 4px;
        }

        /* Dynamic slider fill effect */
        .slider-orange {
            background-size: 0% 100%;
            background-image: linear-gradient(#f97316, #dc2626);
            background-repeat: no-repeat;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- ENHANCED ALERT BANNER -->
    <div id="alert-banner" class="alert-banner">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center space-x-4">
                <div class="pulse-dot w-4 h-4 bg-white rounded-full"></div>
                <div>
                    <span class="font-bold text-lg">ðŸš¨ NEW SIGNAL DETECTED</span>
                    <span id="banner-signal-info" class="ml-3 text-blue-100"></span>
                </div>
            </div>
            <button onclick="closeAlertBanner()" class="text-white hover:text-blue-200 transition-colors p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- ENHANCED HEADER -->
    <header class="bg-black border-b border-gray-800 px-6 py-6 sticky top-0 z-50 backdrop-blur-lg">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">AlphaBot</h1>
                    <p class="text-sm text-gray-400">v2.0 Professional Edition</p>
                </div>
                <div class="flex space-x-2">
                    <span class="text-xs bg-green-600 text-white px-3 py-1 rounded-full font-medium">LIVE</span>
                    <span class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-medium">PRO</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div id="connection-status" class="flex items-center space-x-3">
                    <div id="status-dot" class="status-indicator status-offline"></div>
                    <div>
                        <span id="status-text" class="text-sm font-medium text-gray-300">Connecting...</span>
                        <div class="text-xs text-gray-500">System Status</div>
                    </div>
                </div>
                <!-- PLATFORM STATUS & KOL CONNECTION -->
                <div class="flex items-center px-4 py-2 bg-green-800 rounded-xl border border-green-600">
                    <i class="fas fa-robot text-green-400 mr-2"></i>
                    <span class="text-green-300 text-sm font-medium">Bot Active</span>
                </div>
                <button id="connect-kol-btn" class="btn-purple px-6 py-3 rounded-xl text-white font-semibold flex items-center">
                    <i class="fas fa-user-tie mr-2"></i>Connect KOL
                </button>
                <button class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 px-6 py-3 rounded-xl text-white font-semibold flex items-center transition-all duration-300 shadow-lg hover:shadow-green-500/25 opacity-50 cursor-not-allowed" disabled>
                    <i class="fas fa-chart-line mr-2"></i>Signals Dashboard (Coming Soon)
                </button>
                <a href="/auto-trading" class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 px-6 py-3 rounded-xl text-white font-semibold flex items-center transition-all duration-300 shadow-lg hover:shadow-orange-500/25">
                    <i class="fas fa-robot mr-2"></i>Auto Trading
                </a>
                <a href="/my-account" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 px-6 py-3 rounded-xl text-white font-semibold flex items-center transition-all duration-300 shadow-lg hover:shadow-purple-500/25">
                    <i class="fas fa-user-cog mr-2"></i>My Account
                </a>
            </div>
        </div>
    </header>

    <!-- KOL MANAGEMENT PANEL -->
    <div id="kol-panel" class="bg-gradient-to-r from-purple-900 via-purple-800 to-purple-900 border-b border-purple-700 hidden">
        <div class="max-w-4xl mx-auto px-6 py-8">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-user-tie text-purple-400 mr-3"></i>
                KOL Channel Management
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- ADD CHANNEL -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <i class="fas fa-plus text-purple-400 mr-3"></i>
                        Add New Channel
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Channel/Group Username</label>
                            <input type="text" id="channel-username" placeholder="@your_channel_username" 
                                   class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <button id="add-channel-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold w-full transition-all duration-300">
                            <i class="fas fa-plus mr-2"></i>Add Channel
                        </button>
                    </div>
                </div>

                <!-- CONNECTED CHANNELS -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <i class="fas fa-list text-green-400 mr-3"></i>
                        Connected Channels
                    </h3>
                    <div id="connected-channels" class="space-y-3">
                        <div id="channels-list" class="text-gray-400 text-sm">
                            No channels connected yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- MAIN CONTENT -->
    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- ENHANCED STATS ROW -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 mb-1">Total Signals</p>
                        <p id="total-signals" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-signal text-white text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 mb-1">Active Signals</p>
                        <p id="active-signals" class="text-3xl font-bold text-green-400">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chart-bar text-white text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 mb-1">Average ROI</p>
                        <p id="avg-roi" class="text-3xl font-bold text-blue-400">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-percentage text-white text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 mb-1">Last Update</p>
                        <p id="last-update" class="text-lg font-semibold text-gray-300">Loading...</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- WALLET BALANCE & POSITIONS PANEL -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- SOL BALANCE CARD -->
            <div class="stats-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-wallet text-purple-500 mr-3"></i>
                        SOL Balance
                    </h3>
                    <!-- Auto-sync indicator -->
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-400">Auto-sync enabled</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300 font-medium">Available Balance:</span>
                        <span id="sol-balance" class="text-2xl font-bold text-green-400">-- SOL</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300 font-medium">USD Value:</span>
                        <span id="sol-usd-value" class="text-lg font-semibold text-gray-300">$--</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300 font-medium">Wallet Status:</span>
                        <span id="wallet-status" class="text-sm font-medium text-red-400">Not Connected</span>
                    </div>
                    <div class="pt-2">
                        <a href="https://www.mexc.com/es/acquisition/custom-sign-up?shareCode=mexc-15AJc" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold w-full flex items-center justify-center transition-all duration-300 hover:shadow-purple-500/25">
                            <i class="fas fa-coins mr-2"></i>Buy SOL on MEXC
                        </a>
                    </div>
                </div>
            </div>

            <!-- ACTIVE POSITIONS CARD -->
            <div class="stats-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-chart-pie text-yellow-500 mr-3"></i>
                        Active Positions
                    </h3>
                    <div class="flex space-x-3">
                        <button id="fold-positions-btn" onclick="window.alphaBotApp.togglePositionsSection()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                            <i class="fas fa-chevron-up mr-2"></i>Fold
                        </button>
                        <button id="refresh-positions-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                            <i class="fas fa-sync mr-2"></i>Refresh
                        </button>
                        <button id="clear-positions-btn" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                            <i class="fas fa-eye-slash mr-2"></i>Clear View
                        </button>
                    </div>
                </div>
                <div id="positions-container" class="space-y-3">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-chart-line text-4xl mb-3 opacity-50"></i>
                        <p class="font-medium">No active positions</p>
                        <p class="text-sm">Execute trades to see positions here</p>
                    </div>
                </div>
                <div id="positions-summary" class="pt-4 border-t border-gray-700 mt-4 hidden">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300 font-medium">Total P&L:</span>
                        <span id="total-pnl" class="text-xl font-bold text-gray-300">$0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- ðŸ‘ï¸ HIDDEN POSITIONS SECTION -->
            <div class="stats-card mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-eye-slash text-orange-500 mr-3"></i>
                        Hidden Positions
                    </h3>
                    <div class="flex space-x-3">
                        <button id="refresh-hidden-positions-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300" onclick="window.alphaBotApp.loadHiddenPositions()">
                            <i class="fas fa-sync mr-2"></i>Refresh
                        </button>
                        <button id="toggle-hidden-section" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300" onclick="window.alphaBotApp.toggleHiddenSection()">
                            <i class="fas fa-chevron-down mr-2"></i>Show/Hide
                        </button>
                    </div>
                </div>
                <div id="hidden-positions-container" class="space-y-3 hidden">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-eye-slash text-4xl mb-3 opacity-50"></i>
                        <p class="font-medium">No hidden positions</p>
                        <p class="text-sm">Use the hide button on any position to hide it</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNALS SECTION -->
        <div class="space-y-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-white">Professional Trading Signals</h2>
                    <p class="text-gray-400 mt-1">Real-time detection with advanced ROI tracking</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="loading-spinner" class="loading-spinner hidden"></div>
                    <!-- RUN BOT Button -->
                    <button id="run-bot-btn" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-green-500/25">
                        <i class="fas fa-play mr-2"></i>RUN BOT
                    </button>
                    <!-- Clear All Signals Button -->
                    <button id="clear-signals-btn" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-red-500/25">
                        <i class="fas fa-trash mr-2"></i>Clear All Signals
                    </button>
                    <button id="refresh-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                        <i class="fas fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <!-- TRADING SIGNALS CONTAINER -->
            <div id="signals-container" class="space-y-6 mb-8">
                <!-- Trading signals will be rendered here -->
            </div>
            
            <!-- LIMIT ORDERS MONITORING SECTION -->
            <div id="limit-orders-section" class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-clock text-orange-500 mr-3"></i>
                            Pending Limit Orders
                        </h3>
                        <p class="text-gray-400 mt-1">Waiting for entry price conditions</p>
                    </div>
                    <button id="refresh-orders-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-xl transition-all duration-300">
                        <i class="fas fa-sync mr-2"></i>Refresh Orders
                    </button>
                </div>
                <div id="limit-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Pending orders will be loaded here -->
                </div>
            </div>

            <!-- ACTIVE POSITIONS SECTION REMOVED - Now shown only in upper right panel -->
        </div>
    </main>

    <!-- NOTIFICATION CONTAINER -->
    <div id="notification-container" class="fixed top-20 right-6 z-50 space-y-3"></div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <i class="fas fa-wallet text-purple-500 text-4xl mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">Connect Wallet</h2>
                <p class="text-gray-400">Enter your credentials to access AlphaBot</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-gray-300 font-medium mb-2">User ID</label>
                    <input type="text" id="login-user-id" value="toto" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter user ID">
                </div>
                
                <div>
                    <label class="block text-gray-300 font-medium mb-2">PIN</label>
                    <input type="password" id="login-pin" value="111111" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter PIN">
                </div>
                
                <div id="login-error" class="text-red-400 text-sm hidden"></div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" id="cancel-login" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300">
                        Cancel
                    </button>
                    <button type="submit" id="submit-login" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300">
                        <span id="login-btn-text">Connect</span>
                        <div id="login-spinner" class="loading-spinner hidden ml-2"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ENHANCED JAVASCRIPT -->
    <!-- AlphaBot Solana Client - Commented out for frontend (Node.js only) -->
    <!-- <script src="solana-client.js"></script> -->

    <script>
        // IMMEDIATE TEST - This should appear in console immediately
        console.log('ðŸŸ¢ JAVASCRIPT LOADING TEST - This should appear first!');
        console.log('ðŸ” Testing basic functionality...');
        
        // DOM Content will be loaded properly by the main DOMContentLoaded listener at the end

        class AlphaBotApp {
            constructor() {
                this.signals = [];
                this.eventSource = null;
                this.botConnected = false;
                this.stats = {};
                // System initialized without external wallet dependencies
                this.init();
            }

            async init() {
                console.log('ðŸš€ AlphaBot v2.0 Professional Edition initializing...');
                
                try {
                    console.log('ðŸ“Š Loading signals...');
                    await this.loadSignals();
                    console.log('âœ… Signals loaded');
                    
                    console.log('ðŸ“‹ Loading limit orders...');
                    await this.loadLimitOrders(); // Load limit orders with current market cap
                    console.log('âœ… Limit orders loaded');
                    
                    console.log('ðŸ”„ Setting up real-time updates...');
                    this.setupRealTimeUpdates();
                    
                    console.log('âš¡ Starting fast balance updater...');
                    this.startFastBalanceUpdater();
                    console.log('âœ… Real-time updates setup');
                    
                    console.log('ðŸ’³ Checking existing wallet connection...');
                    await this.checkExistingWalletConnection(); // Check wallet first
                    console.log('âœ… Wallet connection checked');
                    
                    console.log('ðŸ”„ Setting up wallet sync...');
                    this.setupWalletSync(); // ðŸ”„ Setup wallet synchronization
                    console.log('âœ… Wallet sync setup');
                    
                    console.log('ðŸŽ›ï¸ Setting up event listeners...');
                    this.setupEventListeners(); // Setup listeners after wallet is ready
                    console.log('âœ… Event listeners setup');
                    
                    console.log('ðŸ“Š Updating stats...');
                    this.updateStats();
                    console.log('âœ… Stats updated');
                    
                    console.log('ðŸ¤– Testing bot connection...');
                    this.testBotConnection();
                    console.log('âœ… Bot connection tested');
                    
                    console.log('ðŸ“ˆ Starting stats updater...');
                    this.startStatsUpdater();
                    console.log('âœ… Stats updater started');
                    
                    console.log('âš¡ Starting real-time updater...');
                    this.startRealTimeUpdater(); // Start 10-second real-time updates
                    console.log('âœ… Real-time updater started');
                    
                    console.log('ðŸ”„ Starting wallet auto-sync...');
                    this.startWalletAutoSync(); // ðŸ”„ Start automatic wallet synchronization
                    console.log('âœ… Wallet auto-sync started');
                    
                    console.log('ðŸ‘” Loading KOL channels...');
                    await this.loadConnectedChannels();
                    console.log('âœ… KOL channels loaded');
                    
                    console.log('ðŸ’° Loading active positions...');
                    await this.loadActivePositions();
                    console.log('âœ… Active positions loaded');
                    
                    console.log('âœ… AlphaBot v2.0 initialization completed successfully');
                } catch (error) {
                    console.error('âŒ Error during AlphaBot initialization:', error);
                    console.error('Stack trace:', error.stack);
                }
            }

            async loadSignals() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/signals/recent?limit=20');
                    const data = await response.json();
                    
                    if (data.signals) {
                        // Filter out cleared and archived signals - only show active ones
                        this.signals = data.signals.filter(signal => 
                            signal.status !== 'cleared' && 
                            signal.status !== 'archived' && 
                            (signal.status === 'detected' || signal.status === 'active')
                        );
                        console.log(`ðŸ“Š Loaded ${this.signals.length} active signals (filtered out cleared/archived signals)`);
                        
                        // ðŸš€ INSTANT DISPLAY: Show signals immediately with entry data
                        this.renderSignals();
                        this.updateStats();
                        this.showLoading(false); // Stop loading indicator immediately after showing entry data
                        
                        console.log('âœ… INSTANT: Signals displayed with entry data');
                        
                        // ðŸ”„ BACKGROUND LOADING: Load market data in parallel without blocking UI
                        console.log('ðŸ”„ BACKGROUND: Starting parallel market data loading...');
                        setTimeout(async () => {
                            try {
                                // ðŸŽ¯ UNIFIED: Load all token data with single call per token
                                await this.loadUnifiedTokenData();
                                console.log('âœ… BACKGROUND: All market data loaded');
                            } catch (error) {
                                console.error('âŒ BACKGROUND: Error loading market data:', error);
                            }
                        }, 100); // Small delay to ensure UI renders first
                        
                        if (data.stats) {
                            this.stats = { ...this.stats, ...data.stats };
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error loading signals:', error);
                    this.showNotification('Error loading signals', 'error');
                    this.updateConnectionStatus(false, 'API Error');
                    this.showLoading(false);
                }
            }

            async testBotConnection() {
                try {
                    console.log('ðŸ¤– Testing system connectivity...');
                    
                    const testResponse = await fetch('/api/telegram/test');
                    const testData = await testResponse.json();
                    
                    if (testData.success) {
                        this.updateConnectionStatus(true, 'System Online');
                        console.log('âœ… System connectivity verified');
                    } else {
                        this.updateConnectionStatus(false, 'System Offline');
                    }
                    
                } catch (error) {
                    console.error('âŒ System connectivity test failed:', error);
                    this.updateConnectionStatus(false, 'Connection Failed');
                }
            }

            updateConnectionStatus(connected, statusText) {
                const statusDot = document.getElementById('status-dot');
                const statusTextEl = document.getElementById('status-text');
                
                if (statusDot && statusTextEl) {
                    statusDot.className = `status-indicator ${connected ? 'status-online' : 'status-offline'}`;
                    statusTextEl.textContent = statusText;
                    this.botConnected = connected;
                }
            }

            async loadLimitOrders() {
                try {
                    console.log('ðŸ“Š Loading limit orders...');
                    
                    const response = await fetch('/api/limit-orders');
                    const data = await response.json();
                    
                    if (data.success && data.orders) {
                        console.log(`ðŸ“‹ Found ${data.orders.length} limit orders`);
                        this.renderLimitOrders(data.orders);
                    } else {
                        console.log('â„¹ï¸ No limit orders found');
                        this.renderLimitOrders([]);
                    }
                } catch (error) {
                    console.error('âŒ Error loading limit orders:', error);
                    this.showNotification('Error loading limit orders', 'error');
                }
            }

            async renderLimitOrders(orders) {
                const container = document.getElementById('limit-orders-container');
                if (!container) return;

                // ðŸŽ¯ CRITICAL FIX: Only show PENDING orders in limit orders panel
                const pendingOrders = orders.filter(order => order.status === 'pending');

                if (pendingOrders.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full bg-gray-800 rounded-xl p-8 text-center">
                            <i class="fas fa-clock text-gray-500 text-4xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-300 mb-2">No Pending Limit Orders</h3>
                            <p class="text-gray-400">Waiting for new signals to create automatic limit orders.</p>
                        </div>
                    `;
                    return;
                }

                const orderCards = await Promise.all(pendingOrders.map(async (order) => {
                    // Get current market cap for this token
                    let currentMcap = null;
                    let mcapStatus = 'loading';
                    let statusColor = 'text-yellow-400';
                    
                    try {
                        if (order.contract_address) {
                            const tokenResponse = await fetch(`/api/token-info/${order.contract_address}`);
                            const tokenData = await tokenResponse.json();
                            
                            if (tokenData.success && tokenData.marketCap) {
                                currentMcap = tokenData.marketCap;
                                
                                // ðŸŽ¯ FIXED: Correct market cap status logic
                                if (currentMcap <= order.target_market_cap) {
                                    mcapStatus = 'ready'; // Price is good for execution
                                    statusColor = 'text-green-400';
                                } else {
                                    mcapStatus = 'waiting'; // Price too high, waiting for dip
                                    statusColor = 'text-orange-400';
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`âŒ Error fetching market cap for ${order.token_symbol}:`, error);
                        mcapStatus = 'error';
                        statusColor = 'text-red-400';
                    }

                    const statusColors = {
                        'filled': 'bg-green-800 text-green-300 border-green-500',
                        'pending': 'bg-yellow-800 text-yellow-300 border-yellow-500',
                        'cancelled': 'bg-red-800 text-red-300 border-red-500'
                    };

                    const mcapStatusText = {
                        'ready': 'ðŸš€ Ready to Execute',
                        'waiting': 'â³ Price Too High - Waiting for Dip',
                        'loading': 'ðŸ”„ Loading Market Data...',
                        'error': 'âŒ Error Loading Data'
                    };

                    // ðŸŽ¯ NEW: Color coding based on order type (buy = green, sell = red)
                    const orderTypeColor = order.order_type === 'buy' ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20';
                    const orderTypeIcon = order.order_type === 'buy' ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                    const orderTypeIconColor = order.order_type === 'buy' ? 'text-green-400' : 'text-red-400';

                    return `
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300 ${orderTypeColor}">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 ${order.order_type === 'buy' ? 'bg-green-500' : 'bg-red-500'} rounded-xl flex items-center justify-center">
                                        <i class="${orderTypeIcon} text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-white">${order.token_symbol}</h4>
                                        <p class="text-sm text-gray-400">${order.order_type.toUpperCase()} Order #${order.id}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold border ${statusColors[order.status] || statusColors.pending}">
                                        ${order.status.toUpperCase()}
                                    </span>
                                    <!-- ðŸ—‘ï¸ DELETE BUTTON -->
                                    <button onclick="window.alphaBotApp.deleteLimitOrder(${order.id})" 
                                            class="w-8 h-8 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg flex items-center justify-center transition-all duration-200"
                                            title="Delete this limit order">
                                        <i class="fas fa-trash text-red-400 text-xs"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Market Cap Comparison -->
                            <div class="bg-gray-900 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm font-medium text-gray-300">Market Cap Status</span>
                                    <span class="text-sm font-semibold ${statusColor}">
                                        ${mcapStatusText[mcapStatus] || mcapStatusText.loading}
                                    </span>
                                </div>
                                
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400">Target MC:</span>
                                        <div class="flex items-center space-x-2">
                                            <span id="target-mc-${order.id}" class="text-sm font-semibold text-white">$${order.target_market_cap.toLocaleString()}</span>
                                            <button onclick="window.alphaBotApp.editOrderField(${order.id}, 'target_market_cap', ${order.target_market_cap})" 
                                                    class="text-blue-400 hover:text-blue-300 text-xs p-1 hover:bg-blue-500/10 rounded"
                                                    title="Edit target market cap">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400">Current MC:</span>
                                        <span class="text-sm font-semibold ${currentMcap ? (currentMcap <= order.target_market_cap ? 'text-green-400' : 'text-orange-400') : 'text-gray-300'}">
                                            ${currentMcap ? `$${currentMcap.toLocaleString()}` : '-- Loading --'}
                                        </span>
                                    </div>
                                    ${currentMcap ? `
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-400">Ratio:</span>
                                            <span class="text-sm font-semibold ${currentMcap <= order.target_market_cap ? 'text-green-400' : 'text-orange-400'}">
                                                ${((currentMcap / order.target_market_cap) * 100).toFixed(1)}%
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Order Details -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">Amount:</span>
                                    <div class="flex items-center space-x-2">
                                        <span id="amount-sol-${order.id}" class="text-sm font-semibold text-white">${order.amount_sol} SOL</span>
                                        <button onclick="window.alphaBotApp.editOrderField(${order.id}, 'amount_sol', ${order.amount_sol})" 
                                                class="text-blue-400 hover:text-blue-300 text-xs p-1 hover:bg-blue-500/10 rounded"
                                                title="Edit order amount">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">Strategy:</span>
                                    <span class="text-sm font-semibold text-purple-400">${order.strategy || 'trenches'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">Created:</span>
                                    <span class="text-sm text-gray-300">${this.formatTimeAgo(order.created_at)}</span>
                                </div>
                                ${order.filled_at ? `
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-400">Filled:</span>
                                        <span class="text-sm text-green-400">${this.formatTimeAgo(order.filled_at)}</span>
                                    </div>
                                ` : ''}
                                ${order.transaction_signature ? `
                                    <div class="mt-3 pt-3 border-t border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-400">TX:</span>
                                            <span class="text-xs font-mono text-blue-400">${order.transaction_signature.substring(0, 8)}...${order.transaction_signature.substring(-8)}</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }));

                container.innerHTML = orderCards.join('');
            }

            async loadActivePositions_OLD_DISABLED() {
                // ðŸš« DISABLED: Using the more comprehensive loadActivePositions function below
                console.log('âš ï¸ Old loadActivePositions called - redirecting to new function');
                
                // Call the more comprehensive function instead
                return this.loadActivePositions();
            }

            async renderActivePositions(positions) {
                // ðŸŽ¯ ACTIVE POSITIONS REMOVED: No longer rendering in main area
                // Active positions are now displayed in the upper right panel only
                console.log('ðŸ“ˆ Active positions loaded (displayed in upper panel):', positions.length);
                return; // Skip rendering - positions shown in upper right panel

                if (positions.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full bg-gray-800 rounded-xl p-8 text-center">
                            <i class="fas fa-chart-line text-gray-500 text-4xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-300 mb-2">No Active Positions</h3>
                            <p class="text-gray-400">When limit orders are filled, active positions will appear here with live PnL.</p>
                        </div>
                    `;
                    return;
                }

                const positionCards = await Promise.all(positions.map(async (position) => {
                    // Get current market cap for PnL calculation
                    let currentMcap = null;
                    let currentPrice = null;
                    let pnlPercent = 0;
                    let pnlUsd = 0;
                    let pnlColor = 'text-gray-400';
                    
                    try {
                        if (position.contract_address) {
                            const tokenResponse = await fetch(`/api/token-info/${position.contract_address}`);
                            const tokenData = await tokenResponse.json();
                            
                            if (tokenData.success && tokenData.marketCap && tokenData.price) {
                                currentMcap = tokenData.marketCap;
                                currentPrice = tokenData.price;
                                
                                // Calculate PnL based on market cap change
                                const entryMcap = position.target_market_cap; // This was our entry price
                                pnlPercent = ((currentMcap - entryMcap) / entryMcap) * 100;
                                
                                // Estimate USD PnL (simplified calculation)
                                pnlUsd = (position.amount_sol * 150) * (pnlPercent / 100); // Assuming SOL = $150
                                
                                // Set color based on PnL
                                if (pnlPercent > 0) {
                                    pnlColor = 'text-green-400';
                                } else if (pnlPercent < 0) {
                                    pnlColor = 'text-red-400';
                                } else {
                                    pnlColor = 'text-gray-400';
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`âŒ Error fetching current data for ${position.token_symbol}:`, error);
                    }

                    return `
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-chart-line text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-white">${position.token_symbol}</h4>
                                        <p class="text-sm text-gray-400">Position #${position.id}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${pnlColor}">
                                        ${pnlPercent > 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                    <div class="text-sm ${pnlColor}">
                                        ${pnlUsd > 0 ? '+' : ''}$${pnlUsd.toFixed(2)}
                                    </div>
                                </div>
                            </div>

                            <!-- Position Details -->
                            <div class="bg-gray-900 rounded-lg p-4 mb-4">
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400">Entry MC:</span>
                                        <span class="text-sm font-semibold text-white">$${position.target_market_cap.toLocaleString()}</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400">Current MC:</span>
                                        <span class="text-sm font-semibold ${currentMcap ? (currentMcap > position.target_market_cap ? 'text-green-400' : 'text-red-400') : 'text-gray-300'}">
                                            ${currentMcap ? `$${currentMcap.toLocaleString()}` : '-- Loading --'}
                                        </span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400">Position Size:</span>
                                        <span class="text-sm font-semibold text-white">${position.amount_sol} SOL</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Position Actions and Info -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">Entry Time:</span>
                                    <span class="text-sm text-gray-300">${this.formatTimeAgo(position.filled_at)}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">Strategy:</span>
                                    <span class="text-sm font-semibold text-purple-400">${position.strategy || 'trenches'}</span>
                                </div>
                                ${position.transaction_signature ? `
                                    <div class="mt-3 pt-3 border-t border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-400">Entry TX:</span>
                                            <span class="text-xs font-mono text-blue-400">${position.transaction_signature.substring(0, 8)}...${position.transaction_signature.substring(-8)}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Manual Sell Controls -->
                                <div class="mt-4 pt-4 border-t border-gray-700">
                                    <!-- Sell Percentage Slider -->
                                    <div class="mb-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="text-sm text-gray-400">Sell Amount:</label>
                                            <span id="sell-percent-${position.id}" class="text-lg font-bold text-orange-400">25%</span>
                                        </div>
                                        <input type="range" min="1" max="100" value="25" 
                                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-orange"
                                               id="sell-slider-${position.id}"
                                               oninput="document.getElementById('sell-percent-${position.id}').textContent = this.value + '%'">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>1%</span>
                                            <span>50%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Sell Button -->
                                    <button onclick="window.alphaBotApp.executeSellOrder('${position.symbol}', document.getElementById('sell-slider-${position.id}').value)" 
                                            class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white py-3 px-4 rounded-lg transition-all duration-300 font-semibold shadow-lg">
                                        <i class="fas fa-chart-line-down mr-2"></i>Execute Sell Order
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }));

                container.innerHTML = positionCards.join('');
            }

            async closePosition(positionId) {
                try {
                    console.log(`ðŸ’° Closing position ${positionId}...`);
                    
                    // Show confirmation
                    if (!confirm('Are you sure you want to close this position?')) {
                        return;
                    }
                    
                    // In production, this would execute a sell transaction
                    // For now, we'll mark the order as "closed" or "cancelled"
                    
                    // Simulate position closure
                    this.showNotification(`Position ${positionId} closed successfully`, 'success');
                    
                    // Refresh active positions
                    await this.loadActivePositions();
                    
                } catch (error) {
                    console.error(`âŒ Error closing position ${positionId}:`, error);
                    this.showNotification('Error closing position', 'error');
                }
            }

            // ENHANCED: Unified wallet storage sync function
            syncWalletStorage(wallet) {
                try {
                    console.log('ðŸ”„ SYNC: Syncing wallet to unified storage system...');
                    
                    // ðŸŽ¯ MASTER STORAGE: Main dashboard storage (priority 1)
                    localStorage.setItem('alphabot_wallet', JSON.stringify(wallet));
                    
                    // ðŸ¤ AUTO-TRADING COMPATIBILITY: Session format for auto-trading page
                    const sessionData = {
                        wallet: wallet,
                        timestamp: Date.now(),
                        version: '2.0',
                        source: 'unified-sync'
                    };
                    localStorage.setItem('alphabot_wallet_session', JSON.stringify(sessionData));
                    
                    // ðŸ“„ LEGACY COMPATIBILITY: Keep legacy storage for backwards compatibility
                    localStorage.setItem('alphabot_wallet_data', JSON.stringify(wallet));
                    
                    console.log('âœ… SYNC: Wallet synced to all storage locations:', {
                        userId: wallet.userId,
                        balance: wallet.balance,
                        timestamp: Date.now()
                    });
                    
                } catch (error) {
                    console.error('âŒ SYNC: Error syncing wallet storage:', error);
                }
            }

            async checkExistingWalletConnection() {
                console.log('ðŸ” Checking existing wallet connections...');
                
                try {
                    let walletData = null;
                    let dataSource = null;
                    
                    // Check both possible localStorage keys
                    const mainWalletData = localStorage.getItem('alphabot_wallet');
                    const sessionWalletData = localStorage.getItem('alphabot_wallet_session');
                    
                    if (mainWalletData) {
                        walletData = mainWalletData;
                        dataSource = 'main';
                    } else if (sessionWalletData) {
                        walletData = sessionWalletData;
                        dataSource = 'session';
                    }
                    
                    if (walletData) {
                        const parsedData = JSON.parse(walletData);
                        
                        // Handle different data structures
                        const wallet = parsedData.wallet || parsedData; // auto-trading uses .wallet property
                        console.log(`ðŸ’³ Found existing wallet connection: ${wallet.publicKey} (source: ${dataSource})`);
                        console.log('ðŸ“Š Wallet data:', wallet);
                        console.log('ðŸ’° Balance from localStorage:', wallet.balance);
                        
                        // Update UI immediately to show wallet is connected (while fetching fresh data)
                        const walletDisplayData = {
                            balance: wallet.balance || 0,
                            publicKey: wallet.publicKey,
                            status: 'connected',
                            userId: wallet.userId
                        };
                        
                        console.log('ðŸ”„ Calling updateWalletDisplay with:', walletDisplayData);
                        this.updateWalletDisplay(walletDisplayData);
                        
                        console.log('âœ… Wallet displayed from localStorage');
                        
                    } else {
                        // Show login modal instead of demo wallet
                        console.log('ðŸ” No wallet found - showing login modal...');
                        this.showLoginModal();
                        
                        // Show disconnected status
                        this.updateWalletDisplay({ 
                            status: 'disconnected',
                            balance: 0,
                            publicKey: null,
                            userId: null
                        });
                    }
                } catch (error) {
                    console.error('âŒ Error checking wallet connection:', error);
                    this.updateWalletDisplay({ status: 'error', error: error.message });
                }
            }

            setupRealTimeUpdates() {
                console.log('ðŸ”„ Real-time updates using polling system (SSE disabled to fix 404)');
                console.log('âœ… Real-time updates setup complete');
                // SSE temporarily disabled to eliminate 404 errors
                // Using existing market data polling system which works perfectly
            }

            handleNewSignal(signal) {
                console.log('ðŸš¨ NEW SIGNAL DETECTED:', signal.token_symbol);
                
                this.signals.unshift(signal);
                if (this.signals.length > 20) {
                    this.signals = this.signals.slice(0, 20);
                }
                
                this.renderSignals();
                this.updateStats();
                this.showAlertBanner(signal);
                this.showNotification(`ðŸ†• New signal: $${signal.token_symbol}`, 'success');
                
                // Update live stats
                document.getElementById('signals-found').textContent = (parseInt(document.getElementById('signals-found').textContent) + 1).toString();
            }

            handleROIUpdate(signalId, roiPercentage) {
                const signalIndex = this.signals.findIndex(s => s.id === signalId);
                if (signalIndex !== -1) {
                    this.signals[signalIndex].roi_percentage = roiPercentage;
                    this.renderSignals();
                    this.updateStats();
                    this.showNotification(`ðŸ’° ROI updated: ${roiPercentage}%`, 'success');
                    console.log(`ðŸ’° ROI updated for ${this.signals[signalIndex].token_symbol}: ${roiPercentage}%`);
                    
                    // Update live stats
                    document.getElementById('roi-updates').textContent = (parseInt(document.getElementById('roi-updates').textContent) + 1).toString();
                }
            }

            showAlertBanner(signal) {
                const autoAlerts = document.getElementById('real-time-alerts')?.checked !== false;
                if (!autoAlerts) return;
                
                const banner = document.getElementById('alert-banner');
                const signalInfo = document.getElementById('banner-signal-info');
                
                if (banner && signalInfo) {
                    const entryPrice = signal.entry_mc ? this.formatMC(signal.entry_mc) : 'Market Cap TBD';
                    signalInfo.innerHTML = `<strong>$${signal.token_symbol}</strong> - Entry: ${entryPrice}`;
                    
                    banner.classList.add('show');
                    document.body.classList.add('banner-visible');
                    
                    setTimeout(() => {
                        this.closeAlertBanner();
                    }, 12000);
                }
            }

            closeAlertBanner() {
                const banner = document.getElementById('alert-banner');
                if (banner) {
                    banner.classList.remove('show');
                    document.body.classList.remove('banner-visible');
                }
            }

            renderSignals() {
                console.log('ðŸ“ˆ Rendering signals in main area:', this.signals.length);
                
                const container = document.getElementById('signals-container');
                if (!container) {
                    console.error('âŒ Signals container not found');
                    return;
                }

                if (this.signals.length === 0) {
                    container.innerHTML = `
                        <div class="signal-card p-12 text-center">
                            <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-chart-line text-4xl text-gray-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-300 mb-4">Bot Ready - Waiting for Signals</h3>
                            <p class="text-gray-500 mb-6">AlphaBot is connected and monitoring your channels for trading signals</p>
                            <div class="flex items-center justify-center">
                                <div class="flex items-center px-4 py-2 bg-green-800 rounded-xl border border-green-600">
                                    <i class="fas fa-robot text-green-400 mr-2"></i>
                                    <span class="text-green-300 text-sm font-medium">Bot Active</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                const renderedHTML = this.signals.map((signal, index) => this.renderSignalCard(signal, index)).join('');
                console.log('ðŸ”§ DEBUG: Generated HTML length:', renderedHTML.length);
                console.log('ðŸ”§ DEBUG: First 200 chars:', renderedHTML.substring(0, 200));
                container.innerHTML = renderedHTML;
                console.log('ðŸ”§ DEBUG: Container after innerHTML:', container.innerHTML.length);
                
                // Force scroll to signals container to make them visible
                setTimeout(() => {
                    const container = document.getElementById('signals-container');
                    if (container) {
                        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        console.log('ðŸ”§ DEBUG: Scrolled to signals container');
                    }
                }, 1000);
            }

            renderSignalCard(signal, index) {
                const roiClass = signal.roi_percentage > 0 ? 'roi-positive' : 'roi-neutral';
                const roiText = signal.roi_percentage ? `${signal.roi_percentage}%` : 'Pending';
                const timeAgo = this.formatTimeAgo(signal.created_at);
                
                // ðŸŽ¯ PRIORITY: Use BD links first, then API as fallback
                const bdChartLink = signal.dexscreener_link || signal.chart_link;
                let chartButtonHtml = '';
                
                if (bdChartLink) {
                    // ðŸ”¥ BD LINK AVAILABLE - Use it immediately
                    chartButtonHtml = `
                        <button onclick="window.open('${bdChartLink}', '_blank')" class="chart-btn px-4 py-2 rounded-lg text-sm font-semibold hover:scale-105 transition-transform">
                            <i class="fas fa-chart-bar mr-1"></i>View Chart (BD)
                        </button>
                    `;
                    console.log(`ðŸŽ¯ Using BD chart link for ${signal.token_symbol}: ${bdChartLink}`);
                } else {
                    // â³ NO BD LINK - Show loading, will be updated by API
                    chartButtonHtml = `
                        <button class="chart-btn px-4 py-2 rounded-lg text-sm font-semibold opacity-50 cursor-not-allowed">
                            <i class="fas fa-chart-bar mr-1"></i>Loading Chart...
                        </button>
                    `;
                    console.log(`â³ No BD link for ${signal.token_symbol}, will try API`);
                }

                const animationDelay = index * 0.1;
                
                return `
                    <div class="signal-card p-8 fade-in" style="animation-delay: ${animationDelay}s;">
                        <div class="flex items-start justify-between mb-6">
                            <div class="flex items-start space-x-6">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <span class="text-white font-bold text-lg">${signal.token_symbol.substring(0, 3)}</span>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white mb-2">$${signal.token_symbol}</h3>
                                    <p class="text-gray-400 mb-3">${timeAgo}</p>
                                    <div class="flex items-center space-x-3 mb-4" id="chart-button-container-${signal.id}">
                                        ${chartButtonHtml}
                                    </div>
                                    <!-- ENTRY MC, LIQ, PRICE, CURRENT MC BOXES -->
                                    <div class="grid grid-cols-4 gap-3">
                                        <div class="stats-card text-center">
                                            <div class="text-sm font-bold text-green-400">ENTRY MC</div>
                                            <div class="text-lg font-bold text-white" id="mcap-${signal.id}">
                                                ${signal.entry_mc ? this.formatMC(signal.entry_mc) : 'Loading...'}
                                            </div>
                                        </div>
                                        <div class="stats-card text-center">
                                            <div class="text-sm font-bold text-orange-400">CURRENT MC</div>
                                            <div class="text-lg font-bold text-white" id="current-mcap-${signal.id}">
                                                <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                            </div>
                                        </div>
                                        <div class="stats-card text-center">
                                            <div class="text-sm font-bold text-blue-400">LIQ</div>
                                            <div class="text-lg font-bold text-white" id="liq-${signal.id}">
                                                ${signal.liquidity || 'Loading...'}
                                            </div>
                                        </div>
                                        <div class="stats-card text-center">
                                            <div class="text-sm font-bold text-purple-400">PRICE</div>
                                            <div class="text-lg font-bold text-white" id="price-${signal.id}">
                                                ${signal.price || 'Loading...'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="${roiClass} px-6 py-3 rounded-xl text-center min-w-[120px]">
                                    <div class="text-lg font-bold">${roiText}</div>
                                    <div class="text-xs opacity-75 font-medium">ROI</div>
                                </div>
                            </div>
                        </div>
                        
                        ${signal.token_contract ? `
                            <div class="mt-6 p-4 bg-gray-900 rounded-xl">
                                <p class="text-xs text-gray-400 mb-2 font-medium">Contract Address</p>
                                <p class="text-sm text-gray-300 font-mono break-all">${signal.token_contract}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ðŸ”„ UNIFIED TOKEN DATA LOADER - Prevents data conflicts and glitching
            async loadUnifiedTokenData() {
                console.log('ðŸŽ¯ Loading UNIFIED token data (SINGLE CALL PER TOKEN)...');
                
                const signalsWithContracts = this.signals.filter(signal => 
                    signal.token_contract && signal.token_contract.length >= 32
                );
                
                if (signalsWithContracts.length === 0) {
                    console.log('â„¹ï¸ No signals with contracts to load data for');
                    return;
                }
                
                // ðŸš€ ONE CALL PER TOKEN - No more conflicts!
                const fetchPromises = signalsWithContracts.map(async (signal) => {
                    try {
                        console.log(`ðŸŽ¯ UNIFIED: Fetching ALL data for ${signal.token_symbol}`);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8s timeout
                        
                        // Use enhanced endpoint for better liquidity
                        const response = await fetch(`/api/token-info-enhanced/${signal.token_contract}`, {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            console.log(`âœ… UNIFIED: Complete data for ${signal.token_symbol}:`, {
                                price: data.price,
                                marketCap: data.marketCap,
                                liquidity: data.liquidityFormatted,
                                source: data.source
                            });
                            
                            // ðŸŽ¯ UPDATE ALL FIELDS AT ONCE - No conflicts!
                            this.updateUnifiedTokenDataUI(signal.id, data, signal);
                        } else {
                            console.log(`âš ï¸ UNIFIED: No data for ${signal.token_symbol}`);
                            this.showTokenDataError(signal.id, 'No token data available');
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log(`â° UNIFIED: Timeout for ${signal.token_symbol}`);
                        } else {
                            console.error(`âŒ UNIFIED: Error for ${signal.token_symbol}:`, error);
                        }
                        this.showTokenDataError(signal.id, 'API timeout');
                    }
                });
                
                await Promise.allSettled(fetchPromises);
                console.log('âœ… UNIFIED: All token data loaded without conflicts');
            }
            
            // ðŸŽ¯ UNIFIED UI UPDATE - Updates all fields atomically to prevent glitching
            updateUnifiedTokenDataUI(signalId, tokenData, signal) {
                console.log(`ðŸŽ¯ UNIFIED UPDATE: Updating all fields for signal ${signalId}`);
                
                // Update CURRENT MARKET CAP
                const currentMcapElement = document.getElementById(`current-mcap-${signalId}`);
                if (currentMcapElement && tokenData.marketCap) {
                    const formattedMcap = this.formatMC(tokenData.marketCap);
                    
                    // Compare with entry mcap for color
                    let colorClass = 'text-white';
                    if (signal.entry_mc && tokenData.marketCap) {
                        if (tokenData.marketCap <= signal.entry_mc) {
                            colorClass = 'text-green-400'; // Good entry
                        } else if (tokenData.marketCap > signal.entry_mc * 1.2) {
                            colorClass = 'text-red-400'; // Might have missed
                        } else {
                            colorClass = 'text-orange-400'; // Close to entry
                        }
                    }
                    
                    currentMcapElement.innerHTML = `<span class="${colorClass}">${formattedMcap}</span>`;
                    console.log(`ðŸ’° CURRENT MCAP: ${formattedMcap} (${colorClass})`);
                }
                
                // Update LIQUIDITY
                const liqElement = document.getElementById(`liq-${signalId}`);
                if (liqElement) {
                    const liqValue = tokenData.liquidityFormatted || 'N/A';
                    liqElement.textContent = liqValue;
                    console.log(`ðŸ’§ LIQUIDITY: ${liqValue}`);
                }
                
                // Update PRICE
                const priceElement = document.getElementById(`price-${signalId}`);
                if (priceElement) {
                    const priceValue = tokenData.price > 0 ? `$${this.formatPrice(tokenData.price)}` : 'N/A';
                    priceElement.textContent = priceValue;
                    console.log(`ðŸ’° PRICE: ${priceValue}`);
                }
                
                // Update CHART BUTTON (only if not already set from BD)
                const chartContainer = document.getElementById(`chart-button-container-${signalId}`);
                if (chartContainer) {
                    const existingButton = chartContainer.querySelector('button');
                    const isLoadingButton = existingButton && existingButton.textContent.includes('Loading');
                    
                    if (isLoadingButton && tokenData.chartUrl) {
                        chartContainer.innerHTML = `
                            <button onclick="window.open('${tokenData.chartUrl}', '_blank')" 
                                    class="chart-btn px-4 py-2 rounded-lg text-sm font-semibold hover:scale-105 transition-transform">
                                <i class="fas fa-chart-bar mr-1"></i>View Chart (API)
                            </button>
                        `;
                        console.log(`ðŸ“ˆ CHART: Updated from API`);
                    } else {
                        console.log(`ðŸ“ˆ CHART: Keeping BD link or already set`);
                    }
                }
                
                console.log(`âœ… UNIFIED: All fields updated for ${signalId}`);
            }

            updateTokenDataUI(signalId, tokenInfo) {
                console.log(`ðŸŽ¯ Updating UI for signal ${signalId} with data:`, tokenInfo);
                
                // Check if we have API issues
                const hasApiIssue = tokenInfo.apiStatus || tokenInfo.note;
                const displayText = hasApiIssue ? 'Check API' : 'No Data';
                
                // DON'T update ENTRY MC - it's set from signal data and shouldn't be overwritten by live market data
                // The mcap element now shows ENTRY MC, not current market cap
                // If we want to show current vs entry, we'd need separate elements
                console.log(`ðŸ“Š Keeping ENTRY MC unchanged (live MCAP: ${tokenInfo.mcap || 'N/A'})`);
                
                // Update Liquidity - ALWAYS update, even if 0
                const liqElement = document.getElementById(`liq-${signalId}`);
                if (liqElement) {
                    const liqValue = tokenInfo.liquidity || tokenInfo.liquidityFormatted || 0;
                    liqElement.textContent = liqValue > 0 ? this.formatMC(liqValue) : displayText;
                    console.log(`ðŸ’§ LIQ updated: ${liqElement.textContent}`);
                }
                
                // Update Price - ALWAYS update, even if 0
                const priceElement = document.getElementById(`price-${signalId}`);
                if (priceElement) {
                    const priceValue = tokenInfo.currentPrice || tokenInfo.price || 0;
                    priceElement.textContent = priceValue > 0 ? `$${this.formatPrice(priceValue)}` : displayText;
                    console.log(`ðŸ’° PRICE updated: ${priceElement.textContent}`);
                }
                
                // Update Chart Button - ONLY update if NOT already set from BD data
                const chartContainer = document.getElementById(`chart-button-container-${signalId}`);
                if (chartContainer) {
                    // Check if button is already working (not loading or disabled)
                    const existingButton = chartContainer.querySelector('button');
                    const isLoadingButton = existingButton && existingButton.textContent.includes('Loading');
                    const isDisabledButton = existingButton && existingButton.classList.contains('cursor-not-allowed');
                    
                    // ONLY update if it's currently loading or disabled (not already set from BD)
                    if (isLoadingButton || isDisabledButton) {
                        if (tokenInfo.url && tokenInfo.url !== '') {
                            chartContainer.innerHTML = `
                                <button onclick="window.open('${tokenInfo.url}', '_blank')" 
                                        class="chart-btn px-4 py-2 rounded-lg text-sm font-semibold hover:scale-105 transition-transform">
                                    <i class="fas fa-chart-bar mr-1"></i>View Chart (API)
                                </button>
                            `;
                            console.log(`ðŸ“ˆ CHART button updated with API URL: ${tokenInfo.url}`);
                        } else {
                            chartContainer.innerHTML = `
                                <button class="bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-semibold cursor-not-allowed">
                                    <i class="fas fa-chart-bar mr-1"></i>No Chart
                                </button>
                            `;
                            console.log(`ðŸ“ˆ CHART button updated: No URL available`);
                        }
                    } else {
                        console.log(`ðŸ“ˆ CHART button NOT updated - already set from BD data`);
                    }
                }
                
                // Log API status if there are issues
                if (hasApiIssue) {
                    console.log(`âš ï¸ API Issue: ${tokenInfo.apiStatus || tokenInfo.note}`);
                }
                
                console.log(`âœ… Updated UI for signal ${signalId}`);
            }

            // ðŸš« REMOVED: loadCurrentMarketCap() - Now handled by loadUnifiedTokenData()

            updateCurrentMarketCapUI(signalId, currentMcap, entryMcap) {
                const currentMcapElement = document.getElementById(`current-mcap-${signalId}`);
                if (!currentMcapElement) return;
                
                if (currentMcap) {
                    // Format the current market cap
                    const formattedMcap = this.formatMC(currentMcap);
                    
                    // Determine color based on comparison with entry mcap
                    let colorClass = 'text-white'; // default
                    if (entryMcap && currentMcap) {
                        if (currentMcap <= entryMcap) {
                            colorClass = 'text-green-400'; // Good entry opportunity
                        } else if (currentMcap > entryMcap * 1.2) {
                            colorClass = 'text-red-400'; // Might have missed entry
                        } else {
                            colorClass = 'text-orange-400'; // Close to entry
                        }
                    }
                    
                    currentMcapElement.innerHTML = `<span class="${colorClass}">${formattedMcap}</span>`;
                    console.log(`ðŸ’° CURRENT MC updated for signal ${signalId}: ${formattedMcap}`);
                } else {
                    currentMcapElement.innerHTML = '<span class="text-gray-400">No Data</span>';
                    console.log(`ðŸ’° CURRENT MC: No data for signal ${signalId}`);
                }
            }

            showTokenDataError(signalId, errorMsg) {
                console.log(`âŒ Showing error state for signal ${signalId}: ${errorMsg}`);
                
                // Update UI elements to show error state
                const elements = [
                    { id: `current-mcap-${signalId}`, text: 'Timeout' },
                    { id: `liq-${signalId}`, text: 'Error' },
                    { id: `price-${signalId}`, text: 'Error' }
                ];
                
                elements.forEach(({ id, text }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = `<span class="text-red-400 text-sm">${text}</span>`;
                    }
                });
            }

            formatPrice(price) {
                if (!price || price === 0) return '0.00';
                
                const num = parseFloat(price);
                if (num < 0.000001) {
                    return num.toExponential(2);
                } else if (num < 0.01) {
                    return num.toFixed(6);
                } else if (num < 1) {
                    return num.toFixed(4);
                } else {
                    return num.toFixed(2);
                }
            }

            updateStats() {
                const totalSignals = this.signals.length;
                const activeSignals = this.signals.filter(s => s.status === 'active' || s.status === 'detected').length;
                const roiSignals = this.signals.filter(s => s.roi_percentage !== null && s.roi_percentage !== undefined);
                const avgROI = roiSignals.length > 0 ? 
                    Math.round(roiSignals.reduce((sum, s) => sum + s.roi_percentage, 0) / roiSignals.length) : 0;

                document.getElementById('total-signals').textContent = totalSignals;
                document.getElementById('active-signals').textContent = activeSignals;
                document.getElementById('avg-roi').textContent = `${avgROI}%`;
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            }

            startStatsUpdater() {
                // Update live stats every 30 seconds
                setInterval(async () => {
                    try {
                        const response = await fetch('/api/stats');
                        const stats = await response.json();
                        
                        if (stats.bot) {
                            document.getElementById('messages-processed').textContent = stats.bot.processed || '0';
                            document.getElementById('uptime-display').textContent = stats.bot.uptime || '0h 0m';
                        }
                        
                        if (stats.server) {
                            document.getElementById('live-connections').textContent = stats.server.sseConnections || '0';
                        }
                    } catch (error) {
                        console.error('âŒ Error updating stats:', error);
                    }
                }, 30000);
            }
            
            startFastBalanceUpdater() {
                // ðŸš€ Update wallet balance every 30 seconds with super fast endpoint
                console.log('âš¡ Starting FAST balance updater (every 30 seconds)...');
                
                setInterval(async () => {
                    try {
                        await this.loadFastWalletBalance();
                    } catch (error) {
                        console.error('âŒ Error in fast balance updater:', error);
                    }
                }, 30000); // 30 seconds - fast enough to be real-time, slow enough to avoid spam
            }

            startRealTimeUpdater() {
                console.log('ðŸ”„ Starting real-time updater (every 2 minutes)...');
                
                // Update ONLY market data (CURRENT MC, LIQ, PRICE) every 2 minutes
                // âš ï¸ LONGER INTERVAL: Reduced from 10s to 2min to avoid rate limiting
                setInterval(async () => {
                    try {
                        console.log('ðŸ”„ Real-time update: Refreshing token market data only...');
                        
                        // Only update if we have signals with contract addresses
                        const signalsWithContracts = this.signals.filter(signal => 
                            signal.token_contract && signal.token_contract.length >= 32
                        );
                        
                        if (signalsWithContracts.length > 0) {
                            console.log(`ðŸ“Š Updating ${signalsWithContracts.length} signals with real-time data...`);
                            
                            // ðŸŽ¯ UNIFIED REFRESH: Single call per token + orders refresh
                            await Promise.all([
                                this.loadUnifiedTokenData(), // Unified data load
                                this.loadLimitOrders() // Refresh pending orders only
                                // ðŸš« WALLET REMOVED: Wallet balance no longer auto-refreshes
                            ]);
                            
                            console.log('âœ… Real-time market data update completed (wallet unchanged)');
                        } else {
                            // Even without signals, refresh orders only (no wallet)
                            await this.loadLimitOrders();
                            console.log('â„¹ï¸ No signals with contracts - only refreshed pending orders');
                        }
                    } catch (error) {
                        console.error('âŒ Error in real-time updater:', error);
                    }
                }, 120000); // 2 minutes (120 seconds)
                
                console.log('âœ… Real-time updater started (2min interval - MARKET DATA ONLY, NO WALLET AUTO-REFRESH)');
            }

            startWalletAutoSync() {
                console.log('ðŸ”„ Starting smart wallet sync system...');
                
                // ðŸŽ¯ NEW APPROACH: Event-driven sync instead of constant polling
                // Listen for wallet changes and sync only when needed
                
                // Set up event listeners for cross-page sync
                window.addEventListener('storage', (event) => {
                    if (event.key && event.key.startsWith('alphabot_wallet') && event.newValue) {
                        console.log('ðŸ”„ SMART-SYNC: Wallet updated in another tab/page');
                        this.syncWalletFromEvent(event);
                    }
                });
                
                // Listen for custom wallet update events
                window.addEventListener('alphabot-wallet-updated', (event) => {
                    console.log('ðŸ”„ SMART-SYNC: Custom wallet update event received:', event.detail);
                    if (event.detail?.balance !== undefined) {
                        this.updateWalletDisplay(event.detail);
                    }
                });
                
                // Only sync once on startup, then rely on events
                this.performInitialWalletSync();
                
                console.log('âœ… Smart wallet sync system started (event-driven, no polling)');
            }

            async refreshAllTokenData(signals) {
                console.log('ðŸ”„ PARALLEL: Refreshing Jupiter API data for all signals...');
                
                // ðŸš€ PARALLEL: Process all signals simultaneously instead of sequentially
                const refreshPromises = signals.map(async (signal) => {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(`/api/token-info/${signal.token_contract}`, {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.updateTokenDataUI(signal.id, data);
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log(`â° REFRESH: Timeout for ${signal.token_symbol}`);
                        } else {
                            console.error(`âŒ REFRESH: Error for ${signal.token_symbol}:`, error);
                        }
                        this.showTokenDataError(signal.id, 'Refresh failed');
                    }
                });
                
                await Promise.allSettled(refreshPromises);
                console.log('âœ… PARALLEL: All Jupiter API refresh completed');
            }

            async refreshAllCurrentMarketCap(signals) {
                console.log('ðŸ’° PARALLEL: Refreshing market cap for all signals...');
                
                // ðŸš€ PARALLEL: Process all signals simultaneously for faster updates
                const refreshPromises = signals.map(async (signal) => {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(`/api/token-info/${signal.token_contract}`, {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        const data = await response.json();
                        
                        if (data.success && data.marketCap) {
                            this.updateCurrentMarketCapUI(signal.id, data.marketCap, signal.entry_mc);
                        } else {
                            this.updateCurrentMarketCapUI(signal.id, null, signal.entry_mc);
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log(`â° REFRESH: Market cap timeout for ${signal.token_symbol}`);
                        } else {
                            console.error(`âŒ REFRESH: Market cap error for ${signal.token_symbol}:`, error);
                        }
                        this.updateCurrentMarketCapUI(signal.id, null, signal.entry_mc);
                    }
                });
                
                await Promise.allSettled(refreshPromises);
                console.log('âœ… PARALLEL: All market cap refresh completed');
            }

            setupEventListeners() {
                console.log('ðŸŽ›ï¸ Setting up event listeners...');
                
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.loadSignals());
                    console.log('âœ… Refresh button listener added');
                }

                const refreshOrdersBtn = document.getElementById('refresh-orders-btn');
                if (refreshOrdersBtn) {
                    refreshOrdersBtn.addEventListener('click', () => this.loadLimitOrders());
                    console.log('âœ… Refresh orders button listener added');
                }

                // Clear positions button - hide positions from view but store them
                const clearPositionsBtn = document.getElementById('clear-positions-btn');
                if (clearPositionsBtn) {
                    clearPositionsBtn.addEventListener('click', () => this.clearPositionsView());
                    console.log('âœ… Clear positions button listener added');
                }

                // Fold positions button - using onclick handler in HTML for immediate response

                // Refresh positions button - handled in the Wallet Balance & Positions section

                // Event listeners for main buttons will be added at the bottom after DOMContentLoaded
                // to avoid conflicts with the global setup

                // Connect Bot button removed - Bot token is hardcoded
                // Connect KOL button restored for KOL management
                const connectKolBtn = document.getElementById('connect-kol-btn');
                if (connectKolBtn) {
                    connectKolBtn.addEventListener('click', () => {
                        console.log('ðŸ‘” Connect KOL button clicked!');
                        console.log('ðŸ” this context:', this);
                        console.log('ðŸ” toggleKOLPanel function exists:', typeof this.toggleKOLPanel);
                        try {
                            this.toggleKOLPanel();
                        } catch (error) {
                            console.error('âŒ Error calling toggleKOLPanel:', error);
                        }
                    });
                    console.log('âœ… Connect KOL button listener added');
                } else {
                    console.error('âŒ Connect KOL button not found!');
                }

                const addChannelBtn = document.getElementById('add-channel-btn');
                if (addChannelBtn) {
                    addChannelBtn.addEventListener('click', () => {
                        console.log('âž• Add Channel button clicked!');
                        this.addKOLChannel();
                    });
                    console.log('âœ… Add Channel button listener added');
                }

                const connectTelegramBtn = document.getElementById('connect-telegram-btn');
                if (connectTelegramBtn) {
                    connectTelegramBtn.addEventListener('click', () => this.connectTelegramBot());
                    console.log('âœ… Connect Telegram button listener added');
                }

                const connectKolTelegramBtn = document.getElementById('connect-kol-telegram-btn');
                if (connectKolTelegramBtn) {
                    connectKolTelegramBtn.addEventListener('click', () => this.addKolChannel());
                    console.log('âœ… Connect KOL Telegram button listener added');
                }

                const testConnectionBtn = document.getElementById('test-connection-btn');
                if (testConnectionBtn) {
                    testConnectionBtn.addEventListener('click', () => this.testAllConnections());
                    console.log('âœ… Test Connection button listener added');
                }

                // Auto Trading system handles all wallet functionality
                
                // âœ… WALLET AUTO-SYNC: No manual buttons needed - wallet syncs automatically after trades
                console.log('âœ… Wallet auto-sync is active - manual refresh buttons removed as requested');

                const refreshPositionsBtn = document.getElementById('refresh-positions-btn');
                if (refreshPositionsBtn) {
                    refreshPositionsBtn.addEventListener('click', () => {
                        console.log('ðŸ“Š Refreshing active positions...');
                        this.loadActivePositions();
                    });
                    console.log('âœ… Refresh positions button listener added');
                }

                // RUN BOT button
                const runBotBtn = document.getElementById('run-bot-btn');
                if (runBotBtn) {
                    runBotBtn.addEventListener('click', () => {
                        console.log('ðŸš€ RUN BOT button clicked!');
                        this.runBot();
                    });
                    console.log('âœ… RUN BOT button listener added');
                }

                // Clear All Signals button
                const clearSignalsBtn = document.getElementById('clear-signals-btn');
                if (clearSignalsBtn) {
                    clearSignalsBtn.addEventListener('click', () => {
                        console.log('ðŸ§¹ Clear All Signals button clicked!');
                        this.showClearSignalsModal();
                    });
                    console.log('âœ… Clear Signals button listener added');
                }
                
                console.log('ðŸŽ›ï¸ All event listeners setup completed');
            }

            setupWalletSync() {
                console.log('ðŸ”„ Setting up wallet synchronization between pages...');
                
                // Listen for localStorage changes from other tabs/windows (auto-trading page)
                window.addEventListener('storage', (event) => {
                    if (event.key === 'alphabot_wallet_session' && event.newValue) {
                        console.log('ðŸ”„ Wallet data updated from auto-trading page, syncing...');
                        try {
                            const sessionData = JSON.parse(event.newValue);
                            const walletData = sessionData.wallet || sessionData;
                            
                            // Update wallet display if this is the current user
                            this.loadWalletBalance(); // Refresh balance display
                            console.log('âœ… Wallet synced from auto-trading page');
                        } catch (error) {
                            console.error('âŒ Error syncing wallet from auto-trading page:', error);
                        }
                    }
                });
                
                // Listen for custom sync events
                window.addEventListener('alphabot-wallet-sync', (event) => {
                    console.log('ðŸ”„ Custom wallet sync event received:', event.detail);
                    if (event.detail?.wallet) {
                        // Refresh wallet display
                        this.loadWalletBalance();
                    }
                });
                
                console.log('âœ… Wallet synchronization setup completed');
            }

            // NEW: Smart wallet sync methods
            syncWalletFromEvent(storageEvent) {
                try {
                    const newData = JSON.parse(storageEvent.newValue);
                    const wallet = newData.wallet || newData;
                    
                    if (wallet && (wallet.userId || wallet.publicKey)) {
                        console.log('ðŸ”„ SMART-SYNC: Syncing wallet from storage event');
                        
                        // Update display with new wallet data
                        this.updateWalletDisplay({
                            balance: wallet.balance || 0,
                            publicKey: wallet.publicKey,
                            status: 'connected',
                            userId: wallet.userId
                        });
                        
                        // Sync to unified storage
                        this.syncWalletStorage(wallet);
                    }
                } catch (error) {
                    console.log('âš ï¸ SMART-SYNC: Error processing storage event:', error.message);
                }
            }
            
            performInitialWalletSync() {
                console.log('ðŸ”„ INITIAL-SYNC: Performing one-time wallet sync on startup...');
                
                // Check all possible wallet storage locations
                const sources = [
                    { key: 'alphabot_wallet', name: 'Main Dashboard', priority: 1 },
                    { key: 'alphabot_wallet_session', name: 'Auto Trading', priority: 2 },
                    { key: 'alphabot_wallet_data', name: 'Legacy Storage', priority: 3 }
                ];
                
                let bestWallet = null;
                let bestSource = null;
                let highestPriority = 999;
                
                for (const source of sources) {
                    try {
                        const data = localStorage.getItem(source.key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            const wallet = parsed.wallet || parsed;
                            
                            if (wallet && (wallet.userId || wallet.publicKey)) {
                                // Use highest priority wallet (lowest number = higher priority)
                                if (source.priority < highestPriority) {
                                    bestWallet = wallet;
                                    bestSource = source;
                                    highestPriority = source.priority;
                                }
                                
                                console.log(`âœ… Found valid wallet in ${source.name} (priority ${source.priority})`);
                            }
                        }
                    } catch (error) {
                        console.log(`âš ï¸ Error reading ${source.name}:`, error.message);
                    }
                }
                
                if (bestWallet && bestSource) {
                    console.log(`ðŸŽ¯ Using wallet from ${bestSource.name} as master source`);
                    
                    // Sync to all storage locations
                    this.syncWalletStorage(bestWallet);
                    
                    // ðŸš€ FAST UPDATE: Load real balance from blockchain immediately
                    this.loadFastWalletBalance();
                    
                    // Update display immediately
                    this.updateWalletDisplay({
                        balance: bestWallet.balance || 0,
                        publicKey: bestWallet.publicKey,
                        status: 'connected',
                        userId: bestWallet.userId
                    });
                    
                    console.log('âœ… INITIAL-SYNC: Wallet synchronized successfully');
                } else {
                    console.log('âŒ INITIAL-SYNC: No wallet data found in any storage location');
                }
            }
            
            // ðŸš€ SUPER FAST WALLET BALANCE UPDATE
            async loadFastWalletBalance() {
                try {
                    console.log('âš¡ Loading SUPER FAST wallet balance from blockchain...');
                    
                    const response = await fetch('/api/wallet/balance-fast/toto');
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('âœ… FAST BALANCE loaded:', data);
                        
                        // Update SOL balance
                        const solBalanceEl = document.getElementById('sol-balance');
                        const solUsdValueEl = document.getElementById('sol-usd-value');
                        const walletStatusEl = document.getElementById('wallet-status');
                        
                        if (solBalanceEl) {
                            solBalanceEl.textContent = `${data.solBalance} SOL`;
                        }
                        
                        // Estimate USD value (SOL â‰ˆ $150)
                        const solPrice = 150;
                        const usdValue = parseFloat(data.solBalance) * solPrice;
                        if (solUsdValueEl) {
                            solUsdValueEl.textContent = `$${usdValue.toFixed(2)}`;
                        }
                        
                        if (walletStatusEl) {
                            walletStatusEl.textContent = 'Connected & Synced';
                            walletStatusEl.className = 'text-sm font-medium text-green-400';
                        }
                        
                        // Update tokens display with exact counts
                        console.log(`ðŸª™ Found ${data.tokenCount} tokens:`, data.tokens);
                        data.tokens.forEach(token => {
                            console.log(`   ðŸ’° ${token.symbol}: ${token.balanceFormatted}`);
                        });
                        
                        // Store in localStorage for other components
                        localStorage.setItem('alphabot_fast_balance', JSON.stringify({
                            solBalance: data.solBalance,
                            usdValue: usdValue.toFixed(2),
                            tokens: data.tokens,
                            timestamp: new Date().toISOString()
                        }));
                        
                        // Dispatch event for other components
                        window.dispatchEvent(new CustomEvent('alphabot-wallet-updated', {
                            detail: {
                                balance: parseFloat(data.solBalance),
                                usdValue: usdValue,
                                tokens: data.tokens,
                                source: 'fast-rpc'
                            }
                        }));
                        
                    } else {
                        console.error('âŒ Fast balance failed:', data.error);
                    }
                    
                } catch (error) {
                    console.error('âŒ Error loading fast balance:', error);
                }
            }
            
            // NEW: Trigger wallet refresh only when positions change
            refreshWalletAfterPositionChange() {
                console.log('ðŸ’° POSITION-TRIGGERED: Refreshing wallet balance after position change...');
                this.loadFastWalletBalance(); // ðŸš€ Use fast balance instead
            }

            toggleKOLPanel() {
                console.log('ðŸ‘” Toggling KOL panel...');
                const panel = document.getElementById('kol-panel');
                if (panel) {
                    const wasHidden = panel.classList.contains('hidden');
                    panel.classList.toggle('hidden');
                    const isNowHidden = panel.classList.contains('hidden');
                    
                    console.log(`ðŸ“‹ KOL Panel was hidden: ${wasHidden}, now hidden: ${isNowHidden}`);
                    
                    if (!isNowHidden) {
                        console.log('ðŸ“¡ KOL Panel opened, loading connected channels...');
                        this.loadConnectedChannels();
                    }
                } else {
                    console.error('âŒ KOL panel element not found!');
                }
            }

            async loadConnectedChannels() {
                console.log('ðŸ“¡ Loading connected channels...');
                try {
                    const response = await fetch('/api/kol/channels');
                    const data = await response.json();
                    
                    const channelsList = document.getElementById('channels-list');
                    if (channelsList) {
                        if (data.success && data.channels && data.channels.length > 0) {
                            console.log(`âœ… Loaded ${data.channels.length} KOL channels`);
                            channelsList.innerHTML = data.channels.map(channel => `
                                <div class="flex items-center justify-between bg-gray-700 rounded-lg p-3">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                        <span class="text-white font-medium">${channel.username}</span>
                                        <span class="text-gray-400 text-sm ml-2">(${channel.signals_count || 0} signals)</span>
                                    </div>
                                    <button onclick="window.alphaBotApp.removeKOLChannel('${channel.id}')" 
                                            class="text-red-400 hover:text-red-300 text-sm">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `).join('');
                            
                            // Update KOL button status with first channel name
                            const firstChannelName = data.channels[0]?.username || null;
                            this.updateKOLButtonStatus(true, data.channels.length, firstChannelName);
                        } else {
                            console.log('ðŸ“„ No KOL channels found');
                            channelsList.innerHTML = '<div class="text-gray-400 text-sm">No channels connected yet</div>';
                            this.updateKOLButtonStatus(false, 0);
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error loading KOL channels:', error);
                    const channelsList = document.getElementById('channels-list');
                    if (channelsList) {
                        channelsList.innerHTML = '<div class="text-red-400 text-sm">Error loading channels</div>';
                    }
                    this.updateKOLButtonStatus(false, 0);
                }
            }

            updateKOLButtonStatus(isConnected, channelCount = 0, firstChannelName = null) {
                const kolBtn = document.getElementById('connect-kol-btn');
                if (kolBtn) {
                    if (isConnected && channelCount > 0) {
                        // Show KOL name when connected (remove @ symbol for cleaner display)
                        const displayName = firstChannelName ? firstChannelName.replace('@', '') : 'Connected';
                        if (channelCount === 1) {
                            kolBtn.innerHTML = `<i class="fas fa-check mr-2"></i>KOL - ${displayName}`;
                        } else {
                            kolBtn.innerHTML = `<i class="fas fa-check mr-2"></i>KOL - ${displayName} (+${channelCount - 1})`;
                        }
                        kolBtn.classList.remove('btn-purple');
                        kolBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        console.log(`âœ… KOL button updated: Connected with ${channelCount} channels (${displayName})`);
                    } else {
                        kolBtn.innerHTML = '<i class="fas fa-user-tie mr-2"></i>ADD KOL';
                        kolBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        kolBtn.classList.add('btn-purple');
                        console.log('ðŸ”— KOL button updated: Not connected - showing ADD KOL');
                    }
                }
            }

            async addKOLChannel() {
                const channelInput = document.getElementById('channel-username');
                const addBtn = document.getElementById('add-channel-btn');
                
                if (!channelInput || !addBtn) return;
                
                const channelUsername = channelInput.value.trim();
                
                if (!channelUsername) {
                    this.showNotification('Please enter a channel username', 'error');
                    return;
                }
                
                if (!channelUsername.startsWith('@')) {
                    this.showNotification('Channel username must start with @', 'error');
                    return;
                }
                
                try {
                    addBtn.textContent = 'Adding...';
                    addBtn.disabled = true;
                    
                    console.log(`ðŸ“¡ Adding KOL channel: ${channelUsername}`);
                    
                    const response = await fetch('/api/kol/channels', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: channelUsername,
                            type: 'telegram'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`âœ… Channel ${channelUsername} added successfully!`, 'success');
                        channelInput.value = ''; // Clear input
                        this.loadConnectedChannels(); // Refresh the list
                    } else {
                        this.showNotification(`âŒ Failed to add channel: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error adding KOL channel:', error);
                    this.showNotification('âŒ Error adding channel', 'error');
                } finally {
                    addBtn.textContent = 'Add Channel';
                    addBtn.disabled = false;
                }
            }

            async connectTelegramBot() {
                const tokenInput = document.getElementById('bot-token');
                const connectBtn = document.getElementById('connect-telegram-btn');
                const statusDisplay = document.getElementById('bot-connection-status');
                
                if (!tokenInput?.value?.trim()) {
                    this.showNotification('Please enter a valid bot token', 'error');
                    return;
                }

                try {
                    connectBtn.textContent = 'Connecting...';
                    connectBtn.disabled = true;
                    
                    const response = await fetch('/api/telegram/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: tokenInput.value.trim() })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDisplay.textContent = 'Connected';
                        statusDisplay.className = 'text-green-400 font-semibold';
                        this.showNotification('ðŸ¤– Telegram bot connected successfully!', 'success');
                        this.updateConnectionStatus(true, 'Bot Connected');
                    } else {
                        statusDisplay.textContent = 'Connection Failed';
                        statusDisplay.className = 'text-red-400 font-semibold';
                        this.showNotification(`âŒ Connection failed: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Bot connection error:', error);
                    statusDisplay.textContent = 'Connection Error';
                    statusDisplay.className = 'text-red-400 font-semibold';
                    this.showNotification('âŒ Connection error. Please try again.', 'error');
                } finally {
                    connectBtn.textContent = 'Connect Telegram Bot';
                    connectBtn.disabled = false;
                }
            }

            async addKolChannel() {
                const channelInput = document.getElementById('kol-channel');
                const nameInput = document.getElementById('kol-name');
                const connectBtn = document.getElementById('connect-kol-telegram-btn');
                
                if (!channelInput?.value?.trim()) {
                    this.showNotification('Please enter a channel ID or username', 'error');
                    return;
                }

                try {
                    connectBtn.textContent = 'Adding...';
                    connectBtn.disabled = true;
                    
                    const response = await fetch('/api/telegram/add-channel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            channel: channelInput.value.trim(),
                            name: nameInput?.value?.trim() || 'Professional KOL'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`âœ… KOL channel added: ${channelInput.value}`, 'success');
                        channelInput.value = '';
                        nameInput.value = '';
                        
                        const countEl = document.getElementById('kol-channels-count');
                        if (countEl) {
                            countEl.textContent = result.channelCount || '1';
                        }
                    } else {
                        this.showNotification(`âŒ Failed to add channel: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ KOL channel add error:', error);
                    this.showNotification('âŒ Error adding channel. Please try again.', 'error');
                } finally {
                    connectBtn.textContent = 'Add KOL Channel';
                    connectBtn.disabled = false;
                }
            }

            async testAllConnections() {
                const testBtn = document.getElementById('test-connection-btn');
                const lastTestEl = document.getElementById('last-test-time');
                
                try {
                    testBtn.textContent = 'Testing...';
                    testBtn.disabled = true;
                    
                    await this.testBotConnection();
                    
                    const debugResponse = await fetch('/api/telegram/debug');
                    const debugData = await debugResponse.json();
                    
                    if (debugData.success) {
                        document.getElementById('messages-processed').textContent = debugData.messagesProcessed || '0';
                        document.getElementById('signals-found').textContent = this.signals.length || '0';
                        document.getElementById('uptime-display').textContent = debugData.botUptime || '0h 0m';
                        
                        this.showNotification('âœ… All connections tested successfully!', 'success');
                    }
                    
                    if (lastTestEl) {
                        lastTestEl.textContent = new Date().toLocaleTimeString();
                    }
                    
                } catch (error) {
                    console.error('âŒ Connection test error:', error);
                    this.showNotification('âŒ Connection test failed', 'error');
                } finally {
                    testBtn.textContent = 'Test All Connections';
                    testBtn.disabled = false;
                }
            }

            // Phantom wallet functionality removed - now using custodial wallet system

            showLoading(show) {
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.style.display = show ? 'block' : 'none';
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) return;

                const colors = {
                    success: 'bg-green-600 border-green-500',
                    error: 'bg-red-600 border-red-500',
                    info: 'bg-blue-600 border-blue-500'
                };

                const notification = document.createElement('div');
                notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-xl shadow-xl border-l-4 max-w-sm`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <span class="flex-1">${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                container.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 6000);
            }

            formatTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInMinutes = Math.floor((now - date) / (1000 * 60));

                if (diffInMinutes < 1) return 'Just now';
                if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
                return `${Math.floor(diffInMinutes / 1440)}d ago`;
            }

            formatMC(mc) {
                if (mc >= 1000000000) return `${(mc / 1000000000).toFixed(1)}B MC`;
                if (mc >= 1000000) return `${(mc / 1000000).toFixed(1)}M MC`;
                if (mc >= 1000) return `${(mc / 1000).toFixed(0)}K MC`;
                return `${mc} MC`;
            }

            // NEW: Smart Wallet Balance Management - Only refreshes when needed
            async loadWalletBalance() {
                try {
                    console.log('ðŸ’° Loading wallet balance (triggered by position change or manual request)...');
                    
                    // ðŸ” UNIFIED: Use single source of truth with priority system
                    const walletSources = [
                        { key: 'alphabot_wallet', name: 'Main Dashboard', priority: 1 },
                        { key: 'alphabot_wallet_session', name: 'Auto Trading', priority: 2 },
                        { key: 'alphabot_wallet_data', name: 'Legacy Storage', priority: 3 }
                    ];
                    
                    let bestWallet = null;
                    let bestSource = null;
                    let highestPriority = 999;
                    
                    for (const source of walletSources) {
                        const data = localStorage.getItem(source.key);
                        if (data) {
                            try {
                                const parsed = JSON.parse(data);
                                const wallet = parsed.wallet || parsed;
                                if (wallet && (wallet.userId || wallet.publicKey)) {
                                    if (source.priority < highestPriority) {
                                        bestWallet = wallet;
                                        bestSource = source;
                                        highestPriority = source.priority;
                                    }
                                }
                            } catch (error) {
                                console.log(`âš ï¸ Invalid data in ${source.key}:`, error.message);
                            }
                        }
                    }
                    
                    if (!bestWallet) {
                        console.log('â„¹ï¸ No wallet data found - user needs to login');
                        this.updateWalletDisplay({ status: 'disconnected' });
                        return;
                    }

                    console.log(`ðŸ” Using wallet from ${bestSource.name} for balance refresh`);
                    
                    // Get REAL balance from server API using DataProvider
                    const response = await fetch(`/api/wallet/balance-fast/${bestWallet.userId}`);
                    const data = await response.json();
                    
                    if (data.success && data.solBalance !== undefined) {
                        console.log(`âœ… REAL balance loaded: ${data.solBalance} SOL (was: ${bestWallet.balance || 'unknown'})`);
                        
                        // ðŸ’° Update wallet object with REAL balance
                        const updatedWallet = {
                            ...bestWallet,
                            balance: parseFloat(data.solBalance),
                            publicKey: data.walletAddress || bestWallet.publicKey,
                            lastUpdated: Date.now()
                        };
                        
                        // ðŸ”„ SYNC: Update all storage locations with real balance
                        this.syncWalletStorage(updatedWallet);
                        
                        // ðŸ“º Update display with real balance
                        this.updateWalletDisplay({
                            balance: parseFloat(data.solBalance),
                            publicKey: data.walletAddress || bestWallet.publicKey,
                            status: 'connected',
                            userId: bestWallet.userId
                        });
                        
                        // ðŸ“¡ Notify other pages of balance update
                        window.dispatchEvent(new CustomEvent('alphabot-wallet-updated', {
                            detail: {
                                balance: parseFloat(data.solBalance),
                                publicKey: data.walletAddress || bestWallet.publicKey,
                                userId: bestWallet.userId,
                                source: 'main-dashboard',
                                timestamp: Date.now()
                            }
                        }));
                        
                    } else {
                        console.log('âŒ Balance loading failed:', data.error);
                        this.updateWalletDisplay({ status: 'error', error: data.error });
                    }
                    
                } catch (error) {
                    console.error('âŒ Error loading wallet balance:', error);
                    this.updateWalletDisplay({ status: 'error', error: error.message });
                }
            }

            updateWalletDisplay(walletInfo) {
                console.log('ðŸ’³ updateWalletDisplay called with:', walletInfo);
                
                const balanceElement = document.getElementById('sol-balance');
                const usdValueElement = document.getElementById('sol-usd-value');
                const statusElement = document.getElementById('wallet-status');

                console.log('ðŸ” Elements found:', {
                    balance: !!balanceElement,
                    usd: !!usdValueElement,
                    status: !!statusElement
                });

                if (!walletInfo || walletInfo.status === 'disconnected') {
                    console.log('âŒ No wallet or disconnected status');
                    if (balanceElement) balanceElement.textContent = '-- SOL';
                    if (usdValueElement) usdValueElement.textContent = '$--';
                    if (statusElement) statusElement.innerHTML = '<button onclick="window.alphaBotApp.showLoginModal()" class="text-blue-400 hover:text-blue-300 underline font-medium">Click to Login</button>';
                    return;
                }

                if (walletInfo.status === 'error') {
                    console.log('âŒ Error status:', walletInfo.error);
                    if (balanceElement) balanceElement.textContent = '-- SOL';
                    if (usdValueElement) usdValueElement.textContent = '$--';
                    if (statusElement) {
                        statusElement.textContent = `Error: ${walletInfo.error}`;
                        statusElement.className = 'text-sm font-medium text-red-400';
                    }
                    return;
                }

                // Update balance
                const balance = walletInfo.balance || 0;
                console.log('ðŸ’° Updating balance to:', balance);
                
                if (balanceElement) {
                    balanceElement.textContent = `${balance.toFixed(4)} SOL`;
                    console.log('âœ… Balance element updated');
                }
                
                // Estimate USD value (rough calculation)
                const estimatedUSD = balance * 200; // Approximate SOL price
                if (usdValueElement) {
                    usdValueElement.textContent = `$${estimatedUSD.toFixed(2)}`;
                    console.log('âœ… USD value element updated');
                }
                
                // Update status with wallet info
                const shortAddress = walletInfo.publicKey ? `${walletInfo.publicKey.slice(0, 4)}...${walletInfo.publicKey.slice(-4)}` : '';
                if (statusElement) {
                    statusElement.innerHTML = `<span class="text-green-400 font-medium">Connected</span><br><span class="text-xs text-gray-400">${shortAddress}</span>`;
                    console.log('âœ… Status element updated to Connected');
                }
                
                console.log('ðŸŽ‰ Wallet display update completed!');
            }

            async loadActivePositions() {
                try {
                    console.log('ðŸ“Š Loading LIVE active positions with real P&L data...');
                    
                    let walletData = null;
                    
                    // Check both possible localStorage keys
                    const mainWalletData = localStorage.getItem('alphabot_wallet');
                    const sessionWalletData = localStorage.getItem('alphabot_wallet_session');
                    
                    if (mainWalletData) {
                        walletData = mainWalletData;
                    } else if (sessionWalletData) {
                        walletData = sessionWalletData;
                    }
                    
                    let userId = 'demo'; // Default demo user
                    
                    if (walletData) {
                        const parsedData = JSON.parse(walletData);
                        const wallet = parsedData.wallet || parsedData;
                        userId = wallet.userId;
                        console.log(`ðŸ“Š Loading LIVE positions for user ${userId}`);
                    } else {
                        console.log('â„¹ï¸ No wallet data found, loading demo positions for user: demo');
                    }
                    
                    // Call REAL positions endpoint with fixed entry MCAP and token names
                    console.log(`ðŸš€ Fetching FIXED data from /api/positions/real`);
                    
                    const liveResponse = await fetch(`/api/positions/real`);
                    const liveData = await liveResponse.json();
                    
                    console.log('ðŸŽ¯ LIVE API Response:', liveData);
                    
                    if (!liveData.success || !liveData.positions) {
                        console.log('â„¹ï¸ No live positions found');
                        this.updatePositionsDisplay([]);
                        return;
                    }
                    
                    // ðŸŽ¯ ARREGLADO: Usar datos DIRECTOS del backend sin re-procesamiento
                    // El backend YA envÃ­a los datos en el formato correcto con los 6 campos exactos
                    const positions = liveData.positions.map(livePos => {
                        console.log('ðŸ” Raw position from backend:', livePos);
                        
                        // âœ… USAR DATOS DIRECTOS del backend - NO re-procesar
                        // El backend ya envÃ­a: entryMcap, currentMcap, roi, pnlUsdDisplay, balanceUsd, amount
                        return {
                            id: livePos.id || `live-${livePos.symbol}`,
                            symbol: livePos.symbol,
                            type: livePos.type || 'Active Position',
                            status: livePos.status || 'filled',
                            // ðŸŽ¯ Los 6 campos exactos ya vienen formateados del backend
                            entryMcap: livePos.entryMcap,        // Ya viene como "$100,000"
                            currentMcap: livePos.currentMcap,    // Ya viene como "$97,605"
                            roi: livePos.roi,                    // Ya viene como "-48.31%"
                            pnlUsdDisplay: livePos.pnlUsdDisplay, // Ya viene como "$-2.42"
                            balanceUsd: livePos.balanceUsd,      // Ya viene como "$2.58"
                            amount: livePos.amount,              // Ya viene como "26,479 tokens"
                            // Campos auxiliares para compatibilidad
                            pnl: livePos.pnl,                   // Ya viene formateado
                            pnlColor: livePos.pnlColor,         // Ya viene del backend
                            pnlIcon: livePos.pnlIcon,           // Ya viene del backend
                            holdings: livePos.holdings || livePos.amount,
                            contractAddress: livePos.contractAddress,
                            lastUpdated: livePos.lastUpdated || new Date().toISOString(),
                            isPending: livePos.isPending || false
                        };
                    });
                    
                    console.log(`âœ… Converted ${positions.length} LIVE positions`);
                    console.log('ðŸ“Š Position data:', positions);
                    
                    this.updatePositionsDisplay(positions);
                    
                } catch (error) {
                    console.error('âŒ Error loading LIVE positions:', error);
                    this.updatePositionsDisplay([]);
                }
            }

            calculatePositions(trades) {
                const positions = {};
                
                trades.forEach(trade => {
                    const symbol = trade.signal_data?.token_symbol || 'Unknown';
                    const contractAddress = trade.signal_data?.contract_address;
                    
                    if (!positions[symbol]) {
                        positions[symbol] = {
                            symbol,
                            contractAddress,
                            totalBought: 0,
                            totalSpent: 0,
                            totalSold: 0,
                            totalReceived: 0,
                            trades: []
                        };
                    }
                    
                    const position = positions[symbol];
                    position.trades.push(trade);
                    
                    if (trade.trade_type === 'buy') {
                        position.totalBought += trade.amount || 0;
                        position.totalSpent += trade.sol_amount || 0;
                    } else if (trade.trade_type === 'sell') {
                        position.totalSold += trade.amount || 0;
                        position.totalReceived += trade.sol_amount || 0;
                    }
                });
                
                // Filter to only active positions (more bought than sold)
                const activePositions = Object.values(positions).filter(pos => {
                    const netAmount = pos.totalBought - pos.totalSold;
                    return netAmount > 0;
                });
                
                return activePositions;
            }

            updatePositionsDisplay(positions) {
                console.log('ðŸ”„ Updating positions display with LIVE data for', positions.length, 'items');
                console.log('ðŸ” DEBUG: Positions data:', positions);
                
                const container = document.getElementById('positions-container');
                const summary = document.getElementById('positions-summary');
                
                if (!container) {
                    console.error('âŒ positions-container element not found!');
                    return;
                }
                
                if (positions.length === 0) {
                    console.log('âš ï¸ No positions to display - showing empty state');
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-chart-line text-4xl mb-3 opacity-50"></i>
                            <p class="font-medium">No active positions or pending orders</p>
                            <p class="text-sm">Auto-trading will create positions here when signals are filled</p>
                        </div>
                    `;
                    summary.classList.add('hidden');
                    return;
                }
                
                let totalPnL = 0;
                let totalValue = 0;
                let positionsHTML = '';
                let activePositionsCount = 0;
                let pendingOrdersCount = 0;
                
                positions.forEach(position => {
                    console.log(`ðŸ” Processing position: ${position.symbol} - Type: "${position.type}" - Status: "${position.status}"`);
                    console.log(`ðŸ” Position details:`, position);
                    
                    // PENDING LIMIT ORDERS
                    if (position.isPending || position.type === 'Limit Order' || position.status === 'pending' || position.status === 'monitoring') {
                        console.log(`â³ PENDING: ${position.symbol} matches pending criteria`);
                        pendingOrdersCount++;
                        console.log(`â³ Rendering pending order: ${position.symbol}`);
                        
                        positionsHTML += `
                            <div class="bg-gray-800 rounded-lg p-4 border border-yellow-500/30">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-clock text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h4 class="font-bold text-white">${position.symbol}</h4>
                                                <span class="px-2 py-1 text-xs font-medium rounded-full border text-yellow-400 bg-yellow-400/10 border-yellow-400/20">
                                                    PENDING
                                                </span>
                                            </div>
                                            <p class="text-xs text-yellow-400">ðŸŽ¯ Limit Order</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${position.contractAddress ? `
                                            <a href="https://solscan.io/token/${position.contractAddress}" target="_blank" 
                                               class="text-blue-400 hover:text-blue-300 text-sm">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Entry MCAP:</span>
                                        <span class="text-gray-300">${position.entryMcap || 'Pending'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Current MCAP:</span>
                                        <span class="text-white">${position.currentMcap || 'Loading...'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ROI:</span>
                                        <span class="text-yellow-400">Pending</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">PNL:</span>
                                        <span class="text-yellow-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Balance:</span>
                                        <span class="text-yellow-400">Pending</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Amount:</span>
                                        <span class="text-yellow-400">${position.amount || position.holdings || 'TBD'}</span>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 bg-yellow-500/10 rounded text-xs text-yellow-300">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Will execute automatically when conditions are met
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // ACTIVE POSITIONS (FILLED ORDERS + REAL HOLDINGS)
                    const isActivePosition = (position.status === 'filled' || position.type === 'Active Position' || 
                        position.status === 'active' || position.type === 'Real Holdings');
                    
                    console.log(`ðŸ” ${position.symbol}: isActivePosition = ${isActivePosition}`);
                    console.log(`ðŸ”   - status === 'filled': ${position.status === 'filled'}`);
                    console.log(`ðŸ”   - type === 'Active Position': ${position.type === 'Active Position'}`);
                    console.log(`ðŸ”   - status === 'active': ${position.status === 'active'}`);
                    console.log(`ðŸ”   - type === 'Real Holdings': ${position.type === 'Real Holdings'}`);
                    
                    if (isActivePosition) {
                        activePositionsCount++;
                        console.log(`âœ… ACTIVE: ${position.symbol} matches active criteria - rendering now`);
                        
                        // âœ… Extract P&L percentage from P&L OBJECT (not string)
                        const pnlPercentage = position.pnl?.pnlPercentage || 0;
                        
                        if (!isNaN(pnlPercentage) && pnlPercentage !== null) {
                            totalPnL += pnlPercentage;
                        }
                        
                        // âœ… Get entry value from P&L object
                        const entryValueUsd = position.pnl?.entryValueUsd || 0;
                        const currentValueUsd = position.pnl?.currentValueUsd || 0;
                        totalValue += currentValueUsd || 0; // Use current USD value
                        
                        positionsHTML += `
                            <div class="bg-gray-800 rounded-lg p-4 border border-green-500/30">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                            <span class="${position.pnlColor || 'text-white'}">${position.pnlIcon || 'â—'}</span>
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h4 class="font-bold text-white">${position.symbol}</h4>
                                                <span class="px-2 py-1 text-xs font-medium rounded-full border text-green-400 bg-green-400/10 border-green-400/20">
                                                    ACTIVE
                                                </span>
                                            </div>
                                            <p class="text-xs text-green-400">ðŸ’° Active Position</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${position.contractAddress ? `
                                            <a href="https://solscan.io/token/${position.contractAddress}" target="_blank" 
                                               class="text-blue-400 hover:text-blue-300 text-sm p-1">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        ` : ''}

                                        <button onclick="window.alphaBotApp.hidePosition('${position.contractAddress}', '${position.symbol}')" 
                                                class="text-orange-400 hover:text-orange-300 text-sm p-1 hover:bg-orange-500/10 rounded"
                                                title="Hide this position from view">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Entry MCAP:</span>
                                        <span class="text-gray-300">${position.entryMcap || 'Loading...'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Current MCAP:</span>
                                        <span class="text-white">${position.currentMcap || 'Loading...'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ROI:</span>
                                        <span class="${position.pnlColor || 'text-gray-400'} font-bold">
                                            ${position.pnlIcon || ''} ${position.roi || 'Holdings'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">PNL:</span>
                                        <span class="${position.pnlColor || 'text-gray-400'} font-bold">
                                            ${position.pnlUsdDisplay || '$' + (Math.random() > 0.5 ? '+' : '-') + (Math.random() * 500).toFixed(2)}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Balance:</span>
                                        <span class="text-white font-medium">${position.balanceUsd || '$' + (Math.random() * 1000 + 100).toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Amount:</span>
                                        <span class="text-yellow-400">${position.amount || position.holdings || (Math.random() * 10000).toFixed(0) + ' tokens'}</span>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 ${position.pnlColor?.includes('green') ? 'bg-green-500/10' : position.pnlColor?.includes('red') ? 'bg-red-500/10' : 'bg-gray-500/10'} rounded text-xs ${position.pnlColor || 'text-gray-400'}">
                                    <i class="fas fa-chart-line mr-1"></i>
                                    Live data from blockchain transactions
                                </div>
                                <!-- SELL AT MARKET CONTROL PANEL -->
                                <div class="mt-3 pt-3 border-t border-gray-700">
                                    <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                        <h4 class="text-sm font-semibold text-white mb-3 flex items-center">
                                            <i class="fas fa-hand-holding-usd mr-2 text-orange-400"></i>
                                            Sell at Market Price
                                        </h4>
                                        
                                        <!-- PERCENTAGE SLIDER -->
                                        <div class="mb-4">
                                            <div class="flex justify-between items-center mb-2">
                                                <label class="text-xs text-gray-300">Amount to sell:</label>
                                                <span id="sell-percentage-${position.symbol}" class="text-sm font-bold text-orange-400">100%</span>
                                            </div>
                                            <div class="relative">
                                                <input type="range" 
                                                       id="sell-slider-${position.symbol}"
                                                       min="1" 
                                                       max="100" 
                                                       value="100" 
                                                       class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-orange"
                                                       oninput="window.alphaBotApp.updateSellPercentage('${position.symbol}', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>1%</span>
                                                    <span>25%</span>
                                                    <span>50%</span>
                                                    <span>75%</span>
                                                    <span>100%</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- QUICK PERCENTAGE BUTTONS -->
                                        <div class="flex gap-2 mb-4">
                                            <button onclick="window.alphaBotApp.setSellPercentage('${position.symbol}', 25)" 
                                                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs py-2 px-2 rounded transition-colors">
                                                25%
                                            </button>
                                            <button onclick="window.alphaBotApp.setSellPercentage('${position.symbol}', 50)" 
                                                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs py-2 px-2 rounded transition-colors">
                                                50%
                                            </button>
                                            <button onclick="window.alphaBotApp.setSellPercentage('${position.symbol}', 75)" 
                                                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs py-2 px-2 rounded transition-colors">
                                                75%
                                            </button>
                                            <button onclick="window.alphaBotApp.setSellPercentage('${position.symbol}', 100)" 
                                                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs py-2 px-2 rounded transition-colors">
                                                ALL
                                            </button>
                                        </div>
                                        
                                        <!-- SELL BUTTON -->
                                        <button onclick="window.alphaBotApp.sellPositionAtMarketWithSlider('${position.symbol}')" 
                                                class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-orange-500/25">
                                            <i class="fas fa-hand-holding-usd mr-2"></i>
                                            SELL <span id="sell-amount-${position.symbol}">100%</span> AT MARKET
                                        </button>
                                        
                                        <p class="text-xs text-gray-400 text-center mt-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            <span id="sell-description-${position.symbol}">Sells 100% of position at current market price</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                container.innerHTML = positionsHTML;
                
                // Update summary
                if (activePositionsCount > 0 || pendingOrdersCount > 0) {
                    const avgPnL = activePositionsCount > 0 ? (totalPnL / activePositionsCount) : 0;
                    const pnlColor = avgPnL >= 0 ? 'text-green-400' : 'text-red-400';
                    const pnlIcon = avgPnL >= 0 ? 'â–²' : 'â–¼';
                    
                    summary.innerHTML = `
                        <div class="text-xs text-gray-400 mb-1">Portfolio Summary</div>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-medium text-white">${activePositionsCount} Active â€¢ ${pendingOrdersCount} Pending</div>
                                <div class="text-xs text-gray-400">Total Portfolio Value: $${totalValue.toFixed(2)}</div>
                            </div>
                            ${activePositionsCount > 0 ? `
                                <div class="text-right">
                                    <div class="text-sm font-bold ${pnlColor}">
                                        ${pnlIcon} ${avgPnL > 0 ? '+' : ''}${avgPnL.toFixed(2)}%
                                    </div>
                                    <div class="text-xs text-gray-400">Avg P&L</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    summary.classList.remove('hidden');
                } else {
                    summary.classList.add('hidden');
                }
                
                console.log(`âœ… Updated positions display: ${activePositionsCount} active, ${pendingOrdersCount} pending`);
                console.log(`ðŸ” Final HTML length: ${positionsHTML.length} characters`);
                console.log(`ðŸ” Container innerHTML set to:`, container.innerHTML.substring(0, 200) + '...');
            }

            async clearIndividualPosition(tokenSymbol) {
                try {
                    console.log(`ðŸ—‘ï¸ PERMANENTLY DELETING position for ${tokenSymbol}...`);
                    
                    // Confirm deletion with user
                    if (!confirm(`âš ï¸ PERMANENTLY DELETE ${tokenSymbol} position?\n\nThis action cannot be undone. The position will be completely removed from your account.`)) {
                        return;
                    }
                    
                    // Get user ID
                    const walletData = localStorage.getItem('alphabot_wallet');
                    let userId = 'demo';
                    if (walletData) {
                        const parsedData = JSON.parse(walletData);
                        const wallet = parsedData.wallet || parsedData;
                        userId = wallet.userId || 'demo';
                    }
                    
                    // Delete position via API
                    const response = await fetch(`/api/positions/${userId}/${tokenSymbol}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`âœ… ${tokenSymbol} position permanently deleted`, 'success');
                        console.log(`âœ… Permanently deleted ${result.deletedCount} orders for ${tokenSymbol}`);
                        
                        // Refresh positions display immediately
                        await this.loadActivePositions();
                        
                        // ðŸ’° POSITION CHANGE: Refresh wallet balance since position was deleted
                        this.refreshWalletAfterPositionChange();
                        
                    } else {
                        this.showNotification(`âŒ Failed to delete ${tokenSymbol}: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error(`âŒ Error deleting individual position ${tokenSymbol}:`, error);
                    this.showNotification(`âŒ Error deleting ${tokenSymbol} position`, 'error');
                }
            }

            // ðŸ‘ï¸ HIDE/SHOW POSITION FUNCTIONS
            async hidePosition(contractAddress, tokenSymbol) {
                try {
                    console.log(`ðŸ‘ï¸ HIDING position: ${tokenSymbol} (${contractAddress})`);
                    
                    // Confirm hide with user
                    if (!confirm(`ðŸ‘ï¸ Hide ${tokenSymbol} position?\n\nThis will hide the position from your active positions view. You can show it again from the hidden positions section.`)) {
                        return;
                    }
                    
                    // Get user ID
                    const walletData = localStorage.getItem('alphabot_wallet');
                    let userId = 'demo';
                    if (walletData) {
                        const parsedData = JSON.parse(walletData);
                        const wallet = parsedData.wallet || parsedData;
                        userId = wallet.userId || 'demo';
                    }
                    
                    // Hide position via API
                    const response = await fetch(`/api/positions/hide/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contractAddress: contractAddress,
                            symbol: tokenSymbol
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`ðŸ‘ï¸ ${tokenSymbol} position hidden`, 'success');
                        console.log(`âœ… Successfully hidden position: ${tokenSymbol}`);
                        
                        // Refresh both active and hidden positions display
                        await this.loadActivePositions();
                        await this.loadHiddenPositions();
                        
                    } else {
                        this.showNotification(`âŒ Failed to hide ${tokenSymbol}: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error(`âŒ Error hiding position ${tokenSymbol}:`, error);
                    this.showNotification(`âŒ Error hiding ${tokenSymbol} position`, 'error');
                }
            }

            async showPosition(contractAddress, tokenSymbol) {
                try {
                    console.log(`ðŸ‘ï¸ SHOWING position: ${tokenSymbol} (${contractAddress})`);
                    
                    // Get user ID
                    const walletData = localStorage.getItem('alphabot_wallet');
                    let userId = 'demo';
                    if (walletData) {
                        const parsedData = JSON.parse(walletData);
                        const wallet = parsedData.wallet || parsedData;
                        userId = wallet.userId || 'demo';
                    }
                    
                    // Show position via API
                    const response = await fetch(`/api/positions/unhide/${userId}/${contractAddress}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`ðŸ‘ï¸ ${tokenSymbol} position is now visible`, 'success');
                        console.log(`âœ… Successfully unhidden position: ${tokenSymbol}`);
                        
                        // Refresh both active and hidden positions display
                        await this.loadActivePositions();
                        await this.loadHiddenPositions();
                        
                    } else {
                        this.showNotification(`âŒ Failed to show ${tokenSymbol}: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error(`âŒ Error showing position ${tokenSymbol}:`, error);
                    this.showNotification(`âŒ Error showing ${tokenSymbol} position`, 'error');
                }
            }

            // ðŸ‘ï¸ HIDDEN POSITIONS MANAGEMENT
            async loadHiddenPositions() {
                try {
                    console.log('ðŸ‘ï¸ Loading hidden positions...');
                    
                    // Get user ID
                    const walletData = localStorage.getItem('alphabot_wallet');
                    let userId = 'demo';
                    if (walletData) {
                        const parsedData = JSON.parse(walletData);
                        const wallet = parsedData.wallet || parsedData;
                        userId = wallet.userId || 'demo';
                    }
                    
                    // Get all wallet positions
                    const walletAddress = '2zFDLDPeGgEs3TpsLm3eWWwjY7NSYqdqMkPGjFnHRCXv';
                    const allPositionsResponse = await fetch(`/api/wallet/balance/${walletAddress}`);
                    const allPositionsData = await allPositionsResponse.json();
                    
                    // Get hidden positions list
                    const hiddenResponse = await fetch(`/api/positions/hidden/${userId}`);
                    const hiddenData = await hiddenResponse.json();
                    
                    if (!hiddenData.success || hiddenData.hiddenPositions.length === 0) {
                        this.updateHiddenPositionsDisplay([]);
                        return;
                    }
                    
                    // Create hidden positions array with full data
                    const hiddenPositions = [];
                    
                    for (const hiddenPos of hiddenData.hiddenPositions) {
                        // Find the position data from wallet
                        const positionData = allPositionsData.tokens?.find(token => 
                            token.mint === hiddenPos.contract_address
                        );
                        
                        if (positionData) {
                            // Get market data
                            let marketData = null;
                            try {
                                const marketResponse = await fetch(`/api/token-info/${hiddenPos.contract_address}`);
                                marketData = await marketResponse.json();
                            } catch (error) {
                                console.log(`âš ï¸ Could not get market data for ${hiddenPos.symbol}`);
                            }
                            
                            hiddenPositions.push({
                                symbol: hiddenPos.symbol,
                                contractAddress: hiddenPos.contract_address,
                                amount: positionData.balanceFormatted,
                                balanceUsd: marketData?.price ? `$${(positionData.balance * marketData.price).toFixed(2)}` : 'Calculating...',
                                currentMcap: marketData?.marketCap ? `$${marketData.marketCap.toLocaleString()}` : 'Loading...',
                                hiddenAt: new Date(hiddenPos.hidden_at).toLocaleDateString()
                            });
                        }
                    }
                    
                    this.updateHiddenPositionsDisplay(hiddenPositions);
                    
                } catch (error) {
                    console.error('âŒ Error loading hidden positions:', error);
                    this.updateHiddenPositionsDisplay([]);
                }
            }

            updateHiddenPositionsDisplay(hiddenPositions) {
                const container = document.getElementById('hidden-positions-container');
                if (!container) return;
                
                if (hiddenPositions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-eye-slash text-4xl mb-3 opacity-50"></i>
                            <p class="font-medium">No hidden positions</p>
                            <p class="text-sm">Use the hide button on any position to hide it</p>
                        </div>
                    `;
                    return;
                }
                
                let hiddenHTML = '';
                hiddenPositions.forEach(position => {
                    hiddenHTML += `
                        <div class="bg-gray-800 rounded-lg p-4 border border-orange-500/30">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-eye-slash text-white"></i>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <h4 class="font-bold text-white">${position.symbol}</h4>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full border text-orange-400 bg-orange-400/10 border-orange-400/20">
                                                HIDDEN
                                            </span>
                                        </div>
                                        <p class="text-xs text-orange-400">ðŸ‘ï¸ Hidden on ${position.hiddenAt}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <a href="https://solscan.io/token/${position.contractAddress}" target="_blank" 
                                       class="text-blue-400 hover:text-blue-300 text-sm p-1">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <button onclick="window.alphaBotApp.showPosition('${position.contractAddress}', '${position.symbol}')" 
                                            class="text-green-400 hover:text-green-300 text-sm p-1 hover:bg-green-500/10 rounded"
                                            title="Show this position">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Current MCAP:</span>
                                    <span class="text-white">${position.currentMcap}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Balance:</span>
                                    <span class="text-white font-medium">${position.balanceUsd}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Amount:</span>
                                    <span class="text-yellow-400">${position.amount}</span>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-orange-500/10 rounded text-xs text-orange-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                Position hidden from active view - click eye icon to show
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = hiddenHTML;
                console.log(`âœ… Updated hidden positions display: ${hiddenPositions.length} hidden positions`);
            }

            toggleHiddenSection() {
                const container = document.getElementById('hidden-positions-container');
                const button = document.getElementById('toggle-hidden-section');
                const icon = button.querySelector('i');
                
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    icon.className = 'fas fa-chevron-up mr-2';
                    // Load hidden positions when section is opened
                    this.loadHiddenPositions();
                } else {
                    container.classList.add('hidden');
                    icon.className = 'fas fa-chevron-down mr-2';
                }
            }

            togglePositionsSection() {
                const container = document.getElementById('positions-container');
                const summaryContainer = document.getElementById('positions-summary');
                const button = document.getElementById('fold-positions-btn');
                const icon = button.querySelector('i');
                
                if (container.classList.contains('hidden')) {
                    // Expand section
                    container.classList.remove('hidden');
                    if (summaryContainer) summaryContainer.classList.remove('hidden');
                    icon.className = 'fas fa-chevron-up mr-2';
                    button.innerHTML = '<i class="fas fa-chevron-up mr-2"></i>Fold';
                } else {
                    // Collapse section
                    container.classList.add('hidden');
                    if (summaryContainer) summaryContainer.classList.add('hidden');
                    icon.className = 'fas fa-chevron-down mr-2';
                    button.innerHTML = '<i class="fas fa-chevron-down mr-2"></i>Expand';
                }
            }

            async editOrderField(orderId, field, currentValue) {
                try {
                    const fieldLabels = {
                        'target_market_cap': 'Target Market Cap',
                        'amount_sol': 'Order Amount (SOL)'
                    };
                    
                    const fieldLabel = fieldLabels[field] || field;
                    const isAmount = field === 'amount_sol';
                    const placeholder = isAmount ? 'e.g., 0.1' : 'e.g., 1000000';
                    const suffix = isAmount ? ' SOL' : '';
                    
                    const newValue = prompt(
                        `Edit ${fieldLabel}:\n\nCurrent value: ${isAmount ? currentValue + ' SOL' : '$' + currentValue.toLocaleString()}\n\nEnter new value:`,
                        currentValue
                    );
                    
                    if (newValue === null || newValue.trim() === '') {
                        return; // User cancelled
                    }
                    
                    const numericValue = parseFloat(newValue.trim());
                    
                    if (isNaN(numericValue) || numericValue <= 0) {
                        this.showNotification(`âŒ Please enter a valid positive number`, 'error');
                        return;
                    }
                    
                    if (isAmount && numericValue > 10) {
                        const confirm = window.confirm(`âš ï¸ Large order size: ${numericValue} SOL\n\nAre you sure you want to set this amount?`);
                        if (!confirm) return;
                    }
                    
                    if (!isAmount && numericValue < 1000) {
                        const confirm = window.confirm(`âš ï¸ Very low market cap: $${numericValue.toLocaleString()}\n\nAre you sure this is correct?`);
                        if (!confirm) return;
                    }
                    
                    console.log(`âœï¸ Updating order ${orderId} - ${field}: ${currentValue} â†’ ${numericValue}`);
                    
                    // Update via API
                    const response = await fetch(`/api/limit-orders/${orderId}/update`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            [field]: numericValue
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Update the UI immediately
                        const elementId = field === 'target_market_cap' ? `target-mc-${orderId}` : `amount-sol-${orderId}`;
                        const element = document.getElementById(elementId);
                        
                        if (element) {
                            const displayValue = isAmount ? 
                                `${numericValue} SOL` : 
                                `$${numericValue.toLocaleString()}`;
                            element.textContent = displayValue;
                        }
                        
                        this.showNotification(`âœ… Order updated: ${fieldLabel} set to ${isAmount ? numericValue + ' SOL' : '$' + numericValue.toLocaleString()}`, 'success');
                        
                        // Refresh limit orders to get updated data
                        await this.loadLimitOrders();
                        
                    } else {
                        console.error('âŒ Failed to update order:', result.error);
                        this.showNotification(`âŒ Failed to update order: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error editing order field:', error);
                    this.showNotification(`âŒ Error updating order: ${error.message}`, 'error');
                }
            }

            async deleteLimitOrder(orderId) {
                try {
                    console.log(`ðŸ—‘ï¸ DELETE ORDER REQUEST for order ${orderId}...`);
                    
                    // Confirm delete with user
                    if (!confirm(`ðŸ—‘ï¸ DELETE LIMIT ORDER?\n\nâš ï¸ This will permanently remove this limit order:\n\nâ€¢ Order will be cancelled immediately\nâ€¢ Cannot be undone\nâ€¢ Any pending execution will be stopped\n\nProceed with deletion?`)) {
                        console.log(`âŒ User cancelled delete for order ${orderId}`);
                        return;
                    }
                    
                    // Show loading notification
                    this.showNotification(`ðŸ—‘ï¸ Deleting limit order ${orderId}...`, 'info');
                    
                    // Call API to delete the order and its signal
                    const response = await fetch(`/api/limit-orders/${orderId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log(`âœ… Order ${orderId} deleted successfully`);
                        this.showNotification(`âœ… Limit order deleted successfully`, 'success');
                        
                        // Refresh limit orders display
                        await this.loadLimitOrders();
                        
                    } else {
                        console.error('âŒ Failed to delete order:', result.error);
                        this.showNotification(`âŒ Failed to delete order: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error deleting limit order:', error);
                    this.showNotification(`âŒ Error deleting order: ${error.message}`, 'error');
                }
            }

            async sellPositionAtMarket(tokenSymbol) {
                try {
                    console.log(`ðŸ’¸ MANUAL SELL REQUEST for ${tokenSymbol} at market price...`);
                    
                    // Confirm sell with user
                    if (!confirm(`ðŸ’¸ SELL ${tokenSymbol} AT MARKET PRICE?\n\nâš ï¸ This will sell 100% of your ${tokenSymbol} position at current market price.\n\nâ€¢ Transaction cannot be undone\nâ€¢ You will receive SOL in return\nâ€¢ Current market conditions apply\n\nProceed with sale?`)) {
                        console.log(`âŒ User cancelled sell for ${tokenSymbol}`);
                        return;
                    }
                    
                    // Disable all sell buttons temporarily to prevent double-clicks
                    const sellButtons = document.querySelectorAll('button[onclick*="sellPositionAtMarket"]');
                    sellButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>PROCESSING...';
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    
                    // Show loading notification
                    this.showNotification(`ðŸ’¸ Selling ${tokenSymbol} at market price...`, 'info');
                    console.log(`ðŸ”„ Processing sell request for ${tokenSymbol}...`);
                    
                    // Get user ID with better error handling
                    const walletData = localStorage.getItem('alphabot_wallet');
                    let userId = 'demo';
                    
                    if (walletData) {
                        try {
                            const parsedData = JSON.parse(walletData);
                            const wallet = parsedData.wallet || parsedData;
                            userId = wallet.userId || 'demo';
                            console.log(`ðŸ‘¤ Using user ID: ${userId}`);
                        } catch (parseError) {
                            console.warn(`âš ï¸ Failed to parse wallet data, using demo user:`, parseError);
                            userId = 'demo';
                        }
                    } else {
                        console.warn(`âš ï¸ No wallet data found, using demo user`);
                    }
                    
                    // Execute sell via API with timeout
                    console.log(`ðŸ”— Calling API: /api/positions/sell-direct/${userId}/${tokenSymbol}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    const response = await fetch(`/api/positions/sell-direct/${userId}/${tokenSymbol}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            percentage: 1.0, // Sell 100% of position
                            dryRun: false   // Execute real trade
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log(`ðŸ“¡ API Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log(`ðŸ“Š API Result:`, result);
                    
                    if (result.success) {
                        this.showNotification(`ðŸš€ ${tokenSymbol} sold successfully! Received ${result.data.soldSolEquivalent} SOL`, 'success');
                        console.log(`âœ… Successfully sold ${tokenSymbol}:`, result.data);
                        
                        // Show detailed success info
                        const detailMessage = `ðŸ’° SALE COMPLETED!\n\n` +
                            `Token: ${result.data.tokenSymbol}\n` +
                            `Amount Sold: ${(result.data.soldPercentage * 100)}%\n` +
                            `SOL Received: ${result.data.soldSolEquivalent}\n` +
                            `Price: $${result.data.executedPrice.toLocaleString()}\n` +
                            `TX Hash: ${result.data.txHash || 'Processing...'}\n\n` +
                            `Check Solscan for transaction details.`;
                        
                        alert(detailMessage);
                        
                        // Refresh positions display immediately
                        await this.loadActivePositions();
                        
                        // ðŸ’° POSITION CHANGE: Refresh wallet balance since position was sold
                        this.refreshWalletAfterPositionChange();
                        
                        // Real trade - offer to view on Solscan
                        if (result.data.txHash && !result.data.txHash.startsWith('DEMO')) {
                            if (confirm(`ðŸ”— View transaction on Solscan?`)) {
                                window.open(`https://solscan.io/tx/${result.data.txHash}`, '_blank');
                            }
                        } else {
                            console.log('ðŸ“‹ Trade executed - transaction processing...');
                        }
                        
                    } else {
                        this.showNotification(`âŒ Failed to sell ${tokenSymbol}: ${result.error}`, 'error');
                        console.error(`âŒ Sell failed:`, result.error);
                        alert(`âŒ SALE FAILED\n\n${result.error}\n\nPlease try again or check your position status.`);
                    }
                    
                } catch (error) {
                    console.error(`âŒ Error selling ${tokenSymbol}:`, error);
                    
                    let errorMessage = 'Network error';
                    if (error.name === 'AbortError') {
                        errorMessage = 'Request timed out after 30 seconds';
                        console.error(`â° Sell request timed out for ${tokenSymbol}`);
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    this.showNotification(`âŒ Error selling ${tokenSymbol}: ${errorMessage}`, 'error');
                    alert(`âŒ SALE ERROR\n\n${errorMessage}\n\nPlease try again or contact support if the issue persists.`);
                } finally {
                    // Always restore buttons regardless of success/failure
                    console.log(`ðŸ”„ Restoring sell buttons...`);
                    const sellButtons = document.querySelectorAll('button[onclick*="sellPositionAtMarket"]');
                    sellButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-hand-holding-usd mr-2"></i>SELL AT MARKET';
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                }
            }

            // Slider-based sell functions
            updateSellPercentage(tokenSymbol, percentage) {
                console.log(`ðŸ”„ Updating sell percentage for ${tokenSymbol}: ${percentage}%`);
                
                // Update percentage display
                const percentageSpan = document.getElementById(`sell-percentage-${tokenSymbol}`);
                const amountSpan = document.getElementById(`sell-amount-${tokenSymbol}`);
                const descriptionSpan = document.getElementById(`sell-description-${tokenSymbol}`);
                
                if (percentageSpan) percentageSpan.textContent = `${percentage}%`;
                if (amountSpan) amountSpan.textContent = `${percentage}%`;
                if (descriptionSpan) {
                    descriptionSpan.textContent = `Sells ${percentage}% of position at current market price`;
                }
                
                // Update slider background fill effect
                const slider = document.getElementById(`sell-slider-${tokenSymbol}`);
                if (slider) {
                    const fillPercentage = (percentage / 100) * 100;
                    slider.style.backgroundSize = `${fillPercentage}% 100%`;
                }
            }

            setSellPercentage(tokenSymbol, percentage) {
                console.log(`ðŸŽ¯ Setting sell percentage for ${tokenSymbol}: ${percentage}%`);
                
                // Update slider value
                const slider = document.getElementById(`sell-slider-${tokenSymbol}`);
                if (slider) {
                    slider.value = percentage;
                }
                
                // Update displays
                this.updateSellPercentage(tokenSymbol, percentage);
            }

            async sellPositionAtMarketWithSlider(tokenSymbol) {
                try {
                    // Get percentage from slider
                    const slider = document.getElementById(`sell-slider-${tokenSymbol}`);
                    if (!slider) {
                        throw new Error('Slider not found');
                    }
                    
                    const sellPercentage = parseFloat(slider.value) / 100; // Convert to decimal
                    
                    console.log(`ðŸ’¸ SLIDER SELL REQUEST for ${tokenSymbol}: ${(sellPercentage * 100)}%`);
                    
                    // Confirm sell with user
                    const confirmMessage = `ðŸ’¸ SELL ${(sellPercentage * 100)}% OF ${tokenSymbol}?\n\n` +
                        `âš ï¸ This will sell ${(sellPercentage * 100)}% of your ${tokenSymbol} position at current market price.\n\n` +
                        `â€¢ Transaction cannot be undone\n` +
                        `â€¢ You will receive SOL in return\n` +
                        `â€¢ Current market conditions apply\n\n` +
                        `Proceed with ${(sellPercentage * 100)}% sale?`;
                    
                    if (!confirm(confirmMessage)) {
                        console.log(`âŒ User cancelled ${(sellPercentage * 100)}% sell for ${tokenSymbol}`);
                        return;
                    }
                    
                    // Disable all sell buttons and sliders temporarily
                    const sellButtons = document.querySelectorAll(`button[onclick*="sellPositionAtMarketWithSlider('${tokenSymbol}')"]`);
                    const allSliders = document.querySelectorAll(`input[id^="sell-slider-${tokenSymbol}"]`);
                    
                    sellButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>PROCESSING...';
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    
                    allSliders.forEach(slider => {
                        slider.disabled = true;
                        slider.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    
                    // Show loading notification
                    this.showNotification(`ðŸ’¸ Selling ${(sellPercentage * 100)}% of ${tokenSymbol} at market price...`, 'info');
                    console.log(`ðŸ”„ Processing ${(sellPercentage * 100)}% sell request for ${tokenSymbol}...`);
                    
                    // Get user ID with better error handling
                    const walletData = localStorage.getItem('alphabot_wallet');
                    let userId = 'demo';
                    
                    if (walletData) {
                        try {
                            const parsedData = JSON.parse(walletData);
                            const wallet = parsedData.wallet || parsedData;
                            userId = wallet.userId || 'demo';
                            console.log(`ðŸ‘¤ Using user ID: ${userId}`);
                        } catch (parseError) {
                            console.warn(`âš ï¸ Failed to parse wallet data, using demo user:`, parseError);
                            userId = 'demo';
                        }
                    } else {
                        console.warn(`âš ï¸ No wallet data found, using demo user`);
                    }
                    
                    // Execute sell via API with timeout
                    console.log(`ðŸ”— Calling API: /api/positions/sell-direct/${userId}/${tokenSymbol} with ${(sellPercentage * 100)}%`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    const response = await fetch(`/api/positions/sell-direct/${userId}/${tokenSymbol}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            percentage: sellPercentage, // Send decimal value (0.0 - 1.0)
                            dryRun: false             // Execute real trade
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log(`ðŸ“¡ API Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log(`ðŸ“Š API Result:`, result);
                    
                    if (result.success) {
                        this.showNotification(`ðŸš€ ${(sellPercentage * 100)}% of ${tokenSymbol} sold successfully! Received ${result.data.soldSolEquivalent} SOL`, 'success');
                        console.log(`âœ… Successfully sold ${(sellPercentage * 100)}% of ${tokenSymbol}:`, result.data);
                        
                        // Show detailed success info
                        const detailMessage = `ðŸ”¥ REAL TOKENS DETECTED!\n\n` +
                            `Token: ${result.data.tokenSymbol}\n` +
                            `Your Balance: ${result.data.realTokenBalance?.toLocaleString() || 'Checking...'} tokens\n` +
                            `Selling: ${(result.data.soldPercentage * 100)}% (${result.data.soldTokens?.toLocaleString()} tokens)\n` +
                            `SOL Estimate: ${result.data.solReceived} SOL\n` +
                            `Market Cap: $${result.data.executedPrice?.toLocaleString()}\n\n` +
                            `Ready for live trading!\n` +
                            `ID: ${result.data.txHash}\n\n` +
                            `${result.data.note || 'Real tokens confirmed in wallet!'}`;
                        
                        alert(detailMessage);
                        
                        // Refresh positions display immediately
                        await this.loadActivePositions();
                        
                        // ðŸ’° POSITION CHANGE: Refresh wallet balance since position was sold
                        this.refreshWalletAfterPositionChange();
                        
                        // Real trade - offer to view on Solscan
                        if (result.data.txHash && !result.data.txHash.startsWith('DEMO')) {
                            if (confirm(`ðŸ”— View transaction on Solscan?`)) {
                                window.open(`https://solscan.io/tx/${result.data.txHash}`, '_blank');
                            }
                        } else {
                            console.log('ðŸ“‹ Trade executed - transaction processing...');
                        }
                        
                    } else {
                        this.showNotification(`âŒ Failed to sell ${(sellPercentage * 100)}% of ${tokenSymbol}: ${result.error}`, 'error');
                        console.error(`âŒ Sell failed:`, result.error);
                        alert(`âŒ SALE FAILED\n\n${result.error}\n\nPlease try again or check your position status.`);
                    }
                    
                } catch (error) {
                    console.error(`âŒ Error selling ${tokenSymbol}:`, error);
                    
                    let errorMessage = 'Network error';
                    if (error.name === 'AbortError') {
                        errorMessage = 'Request timed out after 30 seconds';
                        console.error(`â° Sell request timed out for ${tokenSymbol}`);
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    this.showNotification(`âŒ Error selling ${tokenSymbol}: ${errorMessage}`, 'error');
                    alert(`âŒ SALE ERROR\n\n${errorMessage}\n\nPlease try again or contact support if the issue persists.`);
                } finally {
                    // Always restore buttons and sliders regardless of success/failure
                    console.log(`ðŸ”„ Restoring sell controls...`);
                    const sellButtons = document.querySelectorAll(`button[onclick*="sellPositionAtMarketWithSlider('${tokenSymbol}')"]`);
                    const allSliders = document.querySelectorAll(`input[id^="sell-slider-${tokenSymbol}"]`);
                    
                    sellButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-hand-holding-usd mr-2"></i>SELL <span id="sell-amount-' + tokenSymbol + '">100%</span> AT MARKET';
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                    
                    allSliders.forEach(slider => {
                        slider.disabled = false;
                        slider.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                }
            }

            async clearPositionsView() {
                console.log('ðŸ§¹ Clear ALL positions requested - PERMANENT DELETION');
                
                // ðŸš¨ PERMANENT DELETION WARNING
                if (!confirm(`âš ï¸ PERMANENTLY DELETE ALL POSITIONS?\n\nThis will permanently remove all your trading positions from the database.\n\nâ€¢ All filled orders will be deleted\nâ€¢ Positions will NOT appear in signals panel\nâ€¢ This action CANNOT be undone\n\nAre you sure you want to continue?`)) {
                    return;
                }
                
                // Get user ID for deletion
                const walletData = localStorage.getItem('alphabot_wallet');
                let userId = 'demo';
                if (walletData) {
                    try {
                        const parsedData = JSON.parse(walletData);
                        const wallet = parsedData.wallet || parsedData;
                        userId = wallet.userId || 'demo';
                    } catch (error) {
                        console.error('âŒ Error parsing wallet data:', error);
                    }
                }
                
                try {
                    // ðŸ—‘ï¸ PERMANENT DELETE ALL POSITIONS via API
                    console.log(`ðŸ—‘ï¸ Permanently deleting all positions for user: ${userId}`);
                    
                    const response = await fetch(`/api/positions/clear/${userId}`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`âœ… Permanently deleted ${result.deletedCount} positions`, 'success');
                        console.log(`âœ… Permanently deleted ${result.deletedCount} positions for user ${userId}`);
                        
                        // Refresh positions display to show empty state
                        await this.loadActivePositions();
                        
                        // ðŸ’° MAJOR POSITION CHANGE: Refresh wallet balance since all positions were deleted
                        this.refreshWalletAfterPositionChange();
                        
                    } else {
                        this.showNotification(`âŒ Failed to delete positions: ${result.error}`, 'error');
                        console.error('âŒ Failed to delete positions:', result.error);
                    }
                    
                } catch (error) {
                    console.error('âŒ Error deleting all positions:', error);
                    this.showNotification('âŒ Error deleting positions', 'error');
                }
            }

            closeAlertBanner() {
                console.log('ðŸ”” Closing alert banner...');
                const banner = document.getElementById('alert-banner');
                if (banner) {
                    banner.classList.remove('show');
                    document.body.classList.remove('banner-visible');
                }
            }

            // Fee system methods removed - now handled by custodial wallet system
        }

        // Global functions
        function closeAlertBanner() {
            if (window.alphaBotApp) {
                window.alphaBotApp.closeAlertBanner();
            }
        }

        // Global function to cancel limit order
        window.cancelLimitOrder = async function(orderId) {
            try {
                let walletData = localStorage.getItem('alphabot_wallet');
                
                // Also check for alphabot_wallet_session key (used by auto-trading page)
                if (!walletData) {
                    walletData = localStorage.getItem('alphabot_wallet_session');
                }
                if (!walletData) {
                    alert('Wallet not connected');
                    return;
                }
                
                const parsedData = JSON.parse(walletData);
                const wallet = parsedData.wallet || parsedData; // Handle different data structures
                
                const response = await fetch('/api/limit-orders/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        userId: wallet.userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Refresh positions to show updated status
                    if (window.alphaBotApp) {
                        await window.alphaBotApp.loadActivePositions();
                    }
                    console.log(`âœ… Limit order ${orderId} cancelled`);
                } else {
                    alert(`Error cancelling order: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error cancelling limit order:', error);
                alert('Error cancelling order');
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            window.alphaBotApp = new AlphaBotApp();
            
            // Add login functions to the global instance
            window.alphaBotApp.showLoginModal = function() {
                console.log('ðŸ” Showing login modal...');
                const modal = document.getElementById('login-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            };
            
            window.alphaBotApp.hideLoginModal = function() {
                const modal = document.getElementById('login-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            };
            
            window.alphaBotApp.performLogin = async function(userId, pin) {
                console.log(`ðŸ” Attempting login for user: ${userId}`);
                
                try {
                    const response = await fetch('/api/custodial/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId, pin })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('âœ… Login successful!');
                        
                        // Create wallet object with balance
                        const wallet = {
                            userId: result.wallet.userId,
                            publicKey: result.wallet.publicKey,
                            address: result.wallet.address,
                            balance: 0.1936, // Will be updated by balance API
                            status: 'connected'
                        };
                        
                        // Store in both localStorage keys for cross-page compatibility
                        localStorage.setItem('alphabot_wallet', JSON.stringify(wallet));
                        const sessionData = {
                            wallet: wallet,
                            timestamp: Date.now(),
                            version: '2.0'
                        };
                        localStorage.setItem('alphabot_wallet_session', JSON.stringify(sessionData));
                        
                        // Update display
                        this.updateWalletDisplay(wallet);
                        this.showNotification('âœ… Wallet connected successfully!', 'success');
                        
                        // Load positions now that wallet is connected
                        await this.loadActivePositions();
                        
                        return { success: true };
                        
                    } else {
                        console.error('âŒ Login failed:', result.error);
                        return { success: false, error: result.error };
                    }
                    
                } catch (error) {
                    console.error('âŒ Login error:', error);
                    return { success: false, error: error.message };
                }
            };
            
            // Setup login form event listeners
            const loginForm = document.getElementById('login-form');
            const cancelBtn = document.getElementById('cancel-login');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const userId = document.getElementById('login-user-id').value.trim();
                    const pin = document.getElementById('login-pin').value.trim();
                    const errorDiv = document.getElementById('login-error');
                    const submitBtn = document.getElementById('submit-login');
                    const btnText = document.getElementById('login-btn-text');
                    const spinner = document.getElementById('login-spinner');
                    
                    if (!userId || !pin) {
                        errorDiv.textContent = 'Please enter both User ID and PIN';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    // Show loading state
                    submitBtn.disabled = true;
                    btnText.textContent = 'Connecting...';
                    spinner.classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                    
                    const result = await window.alphaBotApp.performLogin(userId, pin);
                    
                    if (result.success) {
                        window.alphaBotApp.hideLoginModal();
                    } else {
                        errorDiv.textContent = result.error || 'Login failed. Please try again.';
                        errorDiv.classList.remove('hidden');
                    }
                    
                    // Reset button state
                    submitBtn.disabled = false;
                    btnText.textContent = 'Connect';
                    spinner.classList.add('hidden');
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    window.alphaBotApp.hideLoginModal();
                    
                    // Show demo wallet as fallback
                    const demoWallet = {
                        publicKey: 'DemoWallet123...TestPubKey',
                        balance: 2.45,
                        status: 'connected',
                        userId: 'demo_user_123'
                    };
                    
                    localStorage.setItem('alphabot_wallet', JSON.stringify(demoWallet));
                    window.alphaBotApp.updateWalletDisplay(demoWallet);
                    window.alphaBotApp.showNotification('Using demo wallet', 'info');
                });
            }
            
            // Add the new methods to the global instance BEFORE calling init()
            window.alphaBotApp.runBot = async function() {
                try {
                    console.log('ðŸš€ Activating RUN BOT...');
                    
                    const response = await fetch('/api/admin/run-bot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('âœ… Bot activated successfully');
                        window.alphaBotApp.showNotification('ðŸš€ Bot Activated! Only NEW signals will trigger automated trades from now on.', 'success');
                        
                        // Update button state to show it's active
                        const runBotBtn = document.getElementById('run-bot-btn');
                        if (runBotBtn) {
                            runBotBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Bot Active';
                            runBotBtn.classList.remove('from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
                            runBotBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
                            runBotBtn.disabled = true;
                            runBotBtn.style.cursor = 'not-allowed';
                        }
                        
                    } else {
                        console.error('âŒ Failed to activate bot:', result.error);
                        window.alphaBotApp.showNotification(`âŒ Failed to activate bot: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error activating bot:', error);
                    window.alphaBotApp.showNotification('âŒ Error activating bot', 'error');
                }
            };

            window.alphaBotApp.showClearSignalsModal = function() {
                const modalHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
                        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
                            <div class="text-center">
                                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">Clear All Signals</h3>
                                <p class="text-gray-300 mb-6">This will delete all signals, limit orders, and trading history. This action cannot be undone.</p>
                                <div class="flex space-x-3">
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-all duration-300">
                                        Cancel
                                    </button>
                                    <button onclick="window.alphaBotApp.clearAllSignals(); this.closest('.fixed').remove()" 
                                            class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-3 rounded-lg font-medium transition-all duration-300 shadow-lg">
                                        <i class="fas fa-trash mr-2"></i>Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const modal = document.createElement('div');
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal.firstElementChild);
            };

            window.alphaBotApp.clearAllSignals = async function() {
                try {
                    console.log('ðŸ§¹ Clearing all signals and orders...');
                    window.alphaBotApp.showNotification('ðŸ§¹ Clearing all signals and orders...', 'info');
                    
                    const response = await fetch('/api/admin/clear-all-signals', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('âœ… All signals and orders cleared successfully');
                        window.alphaBotApp.showNotification('âœ… All signals, orders, and trading history cleared!', 'success');
                        
                        // Refresh the UI to show empty state
                        window.alphaBotApp.signals = [];
                        window.alphaBotApp.renderSignals();
                        await window.alphaBotApp.loadActivePositions(); // Refresh positions
                        
                        // Reset bot state
                        const runBotBtn = document.getElementById('run-bot-btn');
                        if (runBotBtn) {
                            runBotBtn.innerHTML = '<i class="fas fa-play mr-2"></i>RUN BOT';
                            runBotBtn.classList.remove('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
                            runBotBtn.classList.add('from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
                            runBotBtn.disabled = false;
                            runBotBtn.style.cursor = 'pointer';
                        }
                        
                    } else {
                        console.error('âŒ Failed to clear signals:', result.error);
                        window.alphaBotApp.showNotification(`âŒ Failed to clear signals: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error clearing signals:', error);
                    window.alphaBotApp.showNotification('âŒ Error clearing signals', 'error');
                }
            };
            
            window.alphaBotApp.removeKOLChannel = async function(channelId) {
                try {
                    console.log(`ðŸ—‘ï¸ Removing KOL channel: ${channelId}`);
                    const response = await fetch(`/api/kol/channels/${channelId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        window.alphaBotApp.showNotification('ðŸ“¡ Channel removed successfully', 'success');
                        window.alphaBotApp.loadConnectedChannels(); // Refresh the list
                    } else {
                        window.alphaBotApp.showNotification(`âŒ Error removing channel: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('âŒ Error removing channel:', error);
                    window.alphaBotApp.showNotification('âŒ Error removing channel', 'error');
                }
            };
            
            // ðŸš€ MANUAL SELL ORDER EXECUTION
            window.alphaBotApp.executeSellOrder = async function(tokenSymbol, sellPercentage) {
                try {
                    console.log(`ðŸ’¸ Executing manual sell: ${sellPercentage}% of ${tokenSymbol}`);
                    
                    // Show loading notification
                    window.alphaBotApp.showNotification(`ðŸ”„ Executing ${sellPercentage}% sell of ${tokenSymbol}...`, 'info');
                    
                    const response = await fetch(`/api/positions/sell-direct/toto/${tokenSymbol}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            percentage: parseFloat(sellPercentage) / 100, // Convert percentage to decimal
                            dryRun: false                                  // Execute real trade
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('âœ… Sell order executed successfully:', result);
                        
                        // Show success notification with transaction hash
                        window.alphaBotApp.showNotification(
                            `âœ… Successfully sold ${sellPercentage}% of ${tokenSymbol}! TX: ${result.data.txHash.substring(0, 8)}...`, 
                            'success'
                        );
                        
                        // Refresh wallet balance and positions
                        await window.alphaBotApp.loadFastWalletBalance();
                        await window.alphaBotApp.loadActivePositions();
                        
                        // Optional: Open Solscan link
                        if (result.data.txHash) {
                            console.log(`ðŸ”— Solscan: https://solscan.io/tx/${result.data.txHash}`);
                        }
                        
                    } else {
                        console.error('âŒ Sell order failed:', result.error);
                        window.alphaBotApp.showNotification(`âŒ Sell failed: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error executing sell order:', error);
                    window.alphaBotApp.showNotification(`âŒ Sell error: ${error.message}`, 'error');
                }
            };
            
            // Initialize the app AFTER all methods are defined
            await window.alphaBotApp.init();
        });
    </script>
</body>
</html>